OnSave
======
`Data Source`_

Данное событие:

- сохраняет данные из формы редактирования
  :doc:`главной записи </components/working_with_sub_prefixes>` во
  :doc:`временные таблицы </database/using_temporary_tables>`;
- если на форме не было ошибок, то сохраняет данные из временных таблиц в оригинальные;
- если на форме не было ошибок, то стирает временные таблицы.

Для копирования данных это событие вызывает метод ``kTempTablesHandler::SaveEdit``, который
копирует данные и стирает :doc:`временные таблицы </database/using_temporary_tables>` по
завершении процесса копирования. После выполнения данного события окно редактирования закрывается
автоматически.

Вызывается из шаблона
---------------------

Данное событие вызывается при нажатии кнопки ``Save`` на панели инструментов в шаблоне редактирования
:doc:`главной записи </components/working_with_sub_prefixes>`. Если нажать на аналогичную кнопку на
шаблоне редактирования :doc:`подчинённой записи </components/working_with_sub_prefixes>` то будет
вызвано событие :doc:`/events/live_editing/on_create` или :doc:`/events/live_editing/on_update`.
Какое конкретно будет выполнено событие определяется тэгом :doc:`/tags/save_event`.

Входные параметры
-----------------

+----------------------------+----------------------------------------------------------------------------------------+
| название                   | описание                                                                               |
+============================+========================================================================================+
| .. config-property::       | Необязательный параметр, позволяющий указать ``ID``, которые будут скопированы         |
|    :name: master_ids       | из :doc:`временных таблиц </database/using_temporary_tables>` в оригинальные.          |
|    :type: array            | Если его не передать (как обычно и происходит), то будут скопированы все данные,       |
|    :ref_prefix: ep_OnSave_ | находящиеся во временных таблицах на момент вызова данного события.                    |
+----------------------------+----------------------------------------------------------------------------------------+
| .. config-property::       | Только **после завершения своей работы** в событии становиться доступен параметр       |
|    :name: ids              | ``ids``, содержащий в себе строку из ``IDs`` (разделённых запятой), которые были       |
|    :type: string           | скопированы в оригинальные таблицы (только ``IDs`` записей из главной таблицы, без     |
|    :ref_prefix: ep_OnSave_ | подчинённых). Данный параметр может использоваться для массовой обработки сохранённых  |
|                            | записей.                                                                               |
+----------------------------+----------------------------------------------------------------------------------------+

Вызывает события
----------------

Для сохранения данных с формы редактирования во :doc:`временные таблицы </database/using_temporary_tables>`
вызывается событие :doc:`/events/onpresave/on_pre_save`. Вызываемый далее метод ``kTempTablesHandler::SaveEdit``
в свою очередь косвенно может вызывать следующие события (события перечислены в порядке вызова):

- :doc:`/events/temp_editing/on_before_delete_from_live`;
- :doc:`/events/temp_editing/on_before_copy_to_live`;
- :doc:`/events/temp_editing/on_after_copy_to_live`.

Потенциальное применение
------------------------

Данное событие можно переписывать с целью работы с данными тогда, когда они уже полностью скопированы
в оригинальные таблицы (см. параметр :ref:`ep_OnSave_ids`). Например для рассылки почтовых извещений
после сохранения записей в оригинальную таблицу. События :doc:`/events/modify_data/on_after_item_create`
и :doc:`/events/modify_data/on_after_item_update` для этого не подходят, т.к. при работе со
:doc:`временными таблицами </database/using_temporary_tables>` они будут вызываться когда данные будут
меняться только во временных таблицах. В таком случае если пользователь нажмёт кнопку ``Cancel`` (событие
:doc:`/events/temp_editing/on_cancel_edit`) на панели инструментов
:doc:`главной записи </components/working_with_sub_prefixes>`, то данные не будут сохранены в оригинальные
таблицы.

Ограничения
-----------

Данное событие можно вызывать только при работе с :doc:`временными таблицами </database/using_temporary_tables>`,
в противном случае произойдёт фатальная ошибка.

.. seealso::

   - :doc:`/database/using_temporary_tables`

.. _Data Source: http://guide.in-portal.org/rus/index.php/EventHandler:OnSave
