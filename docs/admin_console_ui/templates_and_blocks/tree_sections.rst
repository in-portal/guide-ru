Добавление секций в дереве
==========================
`Data Source`_

Дерево, находящееся в административной консоли в левом frame, используется для навигации между её секциями.
Все секции в дерево добавлены используя опцию ``Sections`` в том или ином unit config. Уже добавленные
секции можно изменять через опцию ``SectionAdjustments``, находящуюся в unit config с большим
:ref:`приоритетом <uc_ConfigPriority>`, чем у того unit config, в котором секция описана. Ниже приведён
пример массива, при помощи которого можно добавить новую секцию:

.. code:: php

   'custom:section_name' => Array (
       'parent' => 'custom:parent_section_name',
       'icon' => 'custom:icon_name',
       'label' => 'la_title_SectionName',
       'url' => Array('t' => 'custom/path/to/template', 'pass' => 'm'),
       'permissions' => Array('view', 'add', 'edit', 'delete'),
       'priority' => 1,
       'type' => stTREE,
   ),

Ключом в данном массиве является **осмысленное** название новой секции в дереве. Слово "custom" будет всегда,
т.к. это название модуля.

.. note::

   Секция в дереве будет видна только у того, у кого есть на это право доступа
   (:doc:`permission </components/using_permissions>`).

Обязательные опции
------------------

+-------------------------------+-----------------------------------------------------------------------------------------------+
| название опции                | описание опции                                                                                |
+===============================+===============================================================================================+
| .. config-property::          | Название секции в дереве, в которую будет добавлена эта секция.                               |
|    :name: parent              |                                                                                               |
|    :type: string              |                                                                                               |
|    :ref_prefix: tree_section_ |                                                                                               |
+-------------------------------+-----------------------------------------------------------------------------------------------+
| .. config-property::          | Часть названия пиктограммы секции, которая будет использоваться при её отображении            |
|    :name: icon                | в дереве и над grid (custom - это название модуля). Формат значения:                          |
|    :type: string              | ``<module_name>:<icon_name>``. Сама пиктограмма будет находиться в директории                 |
|    :ref_prefix: tree_section_ | **admin_templates/img/icons** от указанного модуля. Таковым будет полное имя файла            |
|                               | с пиктограммой:                                                                               |
|                               |                                                                                               |
|                               | - ``icon24_<icon_name>.gif`` - для дерева;                                                    |
|                               | - ``icon46_<icon_name>.gif`` - для grid (над ним);                                            |
|                               | - ``icon46_list_<icon_name>.gif`` - для шаблона sections_list.tpl (только в                   |
|                               |   `In-Portal <https://www.in-portal.com/>`__).                                                |
+-------------------------------+-----------------------------------------------------------------------------------------------+
| .. config-property::          | Фраза, перевод которой будет показываться в дереве (должна начинаться с ``la_title_``).       |
|    :name: label               |                                                                                               |
|    :type: string              |                                                                                               |
|    :ref_prefix: tree_section_ |                                                                                               |
+-------------------------------+-----------------------------------------------------------------------------------------------+
| .. config-property::          | Параметры для метода ``kApplication::HREF``, который строит ссылку на секцию в дереве.        |
|    :name: url                 | Элемент массива с ключём ``t`` указывает на шаблон, который будет показан при выборе          |
|    :type: array               | секции. Остальные элементы массива попадают в массив ``$params`` метода                       |
|    :ref_prefix: tree_section_ | ``kApplication::HREF``. Более подробно об их обработке написано в статье о                    |
|                               | :ref:`переменной окружения <env_var_structure>`.                                              |
+-------------------------------+-----------------------------------------------------------------------------------------------+
| .. config-property::          | Список названий типов доступа, которые могут применяться к этой секции. Есть четыре           |
|    :name: permissions         | стандартных типа доступа:                                                                     |
|    :type: array               |                                                                                               |
|    :ref_prefix: tree_section_ | - ``view`` - право на просмотр записей в данной секции;                                       |
|                               | - ``add`` - право на добавление новых записей в данной секции;                                |
|                               | - ``edit`` - право на редактировании ранее созданных записей в данной секции;                 |
|                               | - ``delete`` - право на удаление ранее созданных записей в данной секции.                     |
|                               |                                                                                               |
|                               | Если требуется добавить новый тип доступа, то его название должно начинаться с ``advanced:``, |
|                               | напр. ``advanced:send_email``. Если тот или иной тип доступа не доступен в данной секции,     |
|                               | то его название в данной опции перечислять не надо.                                           |
+-------------------------------+-----------------------------------------------------------------------------------------------+
| .. config-property::          | Позиция секции в дереве (только относительно её родительской секции). Может быть дробной.     |
|    :name: priority            | Если определить несколько секций на одном уровне с одинаковым приоритетом, то показана будет  |
|    :type: float               | только последняя из них. Следовательно у каждой секции должен быть отличный от других секций  |
|    :ref_prefix: tree_section_ | на её уровне приоритет, он же порядковый номер.                                               |
+-------------------------------+-----------------------------------------------------------------------------------------------+

Необязательные опции
--------------------

+-------------------------------+------------------------------------------------------------------------------------------------+
| название опции                | описание опции                                                                                 |
+===============================+================================================================================================+
| .. config-property::          | Название javascript функции, которая будет выполнена при нажатии на эту секцию.                |
|    :name: onclick             | От того, что эта функция вернёт будет зависеть то будет-ли выполнен переход по                 |
|    :type: string              | ссылке построенной из опции ``url``.                                                           |
|    :ref_prefix: tree_section_ |                                                                                                |
+-------------------------------+------------------------------------------------------------------------------------------------+
| .. config-property::          | .. versionadded:: 4.2.1                                                                        |
|    :name: container           |                                                                                                |
|    :type: boolean             | Указывает на то, что данная секция является только контейнером для других секций.              |
|    :ref_prefix: tree_section_ | В таком случае при нажатии на эту секция в дереве будет открыта первая секция,                 |
|                               | которая не является контейнером и является дочерней данной секции.                             |
+-------------------------------+------------------------------------------------------------------------------------------------+
| .. config-property::          | Позволяет регулировать видимость секции, возможные значения:                                   |
|    :name: show_mode           |                                                                                                |
|    :type: int                 | - ``smDEBUG`` - показывать только в отладочном режиме (DEBUG MODE);                            |
|    :ref_prefix: tree_section_ | - ``smSUPER_ADMIN`` - показывать только в Super Admin режиме и в отладочном режиме;            |
|                               | - ``true`` - всегда показывать (значение по умолчанию);                                        |
|                               | - ``false`` - никогда не показывать;                                                           |
|                               |                                                                                                |
|                               | .. versionadded:: 5.0.0                                                                        |
|                               |                                                                                                |
|                               | - ``smNORMAL`` - показать ту секцию, которая ранее была задана с видимостью ``smSUPER_ADMIN``; |
|                               | - ``smHIDE`` - никогда не показывать.                                                          |
+-------------------------------+------------------------------------------------------------------------------------------------+
| .. config-property::          | Позволяет задать :doc:`префикс </components/unit_configs/config_files>`, который будет         |
|    :name: SectionPrefix       | использоваться для проверки :doc:`прав доступа </components/using_permissions>` к              |
|    :type: string              | секции. Если не задан, то будет использоваться тот префикс, в котором данная секция            |
|    :ref_prefix: tree_section_ | объявлена.                                                                                     |
|                               |                                                                                                |
|                               | .. note::                                                                                      |
|                               |                                                                                                |
|                               |    Также можно задать :ref:`одноимённую <uc_SectionPrefix>` опцию в                            |
|                               |    :doc:`конфигурационном файле </components/unit_configs/config_files>`. В таком случае       |
|                               |    заданный префикс для проверки прав доступа будет относиться ко всем секциям определённым    |
|                               |    в данном конфигурационном файле.                                                            |
+-------------------------------+------------------------------------------------------------------------------------------------+

.. include:: /includes/needs_refactoring.rst

.. caution::

   Ошибка: значение ключа :ref:`tree_section_show_mode` равное ``false`` в v4.3.9 не прячет секцию, а изменяет шаблон
   в ней на ``index``. Пока что рекомендуется использовать способ убирания секции, описанный ниже в статье.

Изменение секций
----------------

Бывают ситуации, при которых требуется изменить некоторые из параметров в объявлении секции или просто её убрать.
В случае, когда секция объявлена в таком :doc:`unit config </components/unit_configs/config_files>`, который
запрещено изменять (напр. под папкой ``core``), то следует воспользоваться одним из ниже приведённых подходов.

.. warning::

   Ни в коем случае не следует переопределять секцию в другом
   :doc:`unit config </components/unit_configs/config_files>`. Если это сделать, то тогда потеряется связка
   самой секции с тем unit config, где она была изначально объявлена. Это повлечёт за собой неправильную
   проверку :doc:`прав доступа </components/using_permissions>` при работе с данными, показываемыми в этой
   секции.

Использование события OnAfterConfigRead
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

Следует сделать :doc:`after hook </components/unit_configs/hooks>` на событие
:doc:`/events/general/on_after_config_read` того :ref:`префикса <uc_Prefix>`, в
:doc:`unit config </components/unit_configs/config_files>` которого объявлена эта секция.
Тело hook будет находиться в том :doc:`обработчике событий </components/event_handler/event_handlers>`,
чей unit config хочет изменить определение секции. В теле hook уже можно свободно изменять требуемый unit
config следующим образом:

.. code:: php

   /**
    * [HOOK] Changes unit config of prefix "shipping"
    *
    * @param kEvent $event
    */
   function OnModifyShippingConfig(&$event)
   {
       $sections = $this->Application->getUnitOption($event->MasterEvent->Prefix, 'Sections');

       $sections['in-commerce:shippings']['show_mode'] = smDEBUG;

       $this->Application->setUnitOption($event->MasterEvent->Prefix, 'Sections', $sections);
   }

Данный подход можно глобально применять для динамического изменения почти любых данных в других
:doc:`unit config </components/unit_configs/config_files>`.

Использование опции SectionAdjustments
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

Другим и более предпочтительным способом является использование опции :ref:`uc_SectionAdjustments`
в :doc:`unit config </components/unit_configs/config_files>`. При использовании данного способа можно
массово изменять и убирать секции и при этом даже не знать где они были объявлены. Единственным условием
является то, что unit config содержащий данную опцию должен обрабатываться после всех тех unit configs,
в которых объявлены изменяемые секции.

Содержание данной опции также, как и опции :ref:`uc_Sections` является массивом, в котором ключи - это
названия секций в дереве. В качестве значения каждой изменяемой секции нужно указать массив её изменённых
параметров или слово ``remove``, в случае, когда секцию нужно убрать:

.. code:: php

   'SectionAdjustments' => Array (
       'in-portal:configure_themes' => Array (
           'priority' => 10.036,
           'show_mode' => smDEBUG,
       ),

       'in-portal:tools' => 'remove',
   ),

.. _Data Source: http://guide.in-portal.org/rus/index.php/K4:%D0%94%D0%BE%D0%B1%D0%B0%D0%B2%D0%BB%D0%B5%D0%BD%D0%B8%D0%B5_%D1%81%D0%B5%D0%BA%D1%86%D0%B8%D0%B9_%D0%B2_%D0%B4%D0%B5%D1%80%D0%B5%D0%B2%D0%B5
