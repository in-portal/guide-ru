Константы
*********
`Data Source`_ `Eng Data Source`_ `Confluence`_

В К4 константы делятся по смыслу исходя из места их определения на:

- **системные** - определяются в ``core/kernel/startup.php``
- **общего применения** - определяются в ``core/kernel/constants.php``
- **модульные** - определяются в необязательном файле ``<название_модуля>/constants.php``

Системные константы
===================

+---------------------------+--------------------------------------------------------------------------------------------------+
| название                  | описание                                                                                         |
+===========================+==================================================================================================+
| .. config-property::      | Полный путь к сайту в файловой системе сервера.                                                  |
|    :name: FULL_PATH       |                                                                                                  |
|    :ref_prefix: const_    |                                                                                                  |
+---------------------------+--------------------------------------------------------------------------------------------------+
| .. config-property::      | Директория, в которой находится сайт (относительно                                               |
|    :name: BASE_PATH       | `$_SERVER['DOCUMENT_ROOT'] <http://lv.php.net/reserved.variables>`__)                            |
|    :ref_prefix: const_    |                                                                                                  |
+---------------------------+--------------------------------------------------------------------------------------------------+
| .. config-property::      | Путь от корня проекта до PHP-файла (обычно это ``index.php``), на который заходит пользователь.  |
|    :name: REL_PATH        | Объявление данной константы должно происходить до или сразу после объявления константы           |
|    :ref_prefix: const_    | :ref:`const_FULL_PATH` в этом PHP-файле. Данная константа должна задаваться во всех случаях,     |
|                           | когда PHP-файл не находиться в корне проекта или в его ``admin`` директории. Примеры:            |
|                           |                                                                                                  |
|                           |  - файл: "testing/folder/index.php" - константа: "testing/folder"                                |
|                           |  - файл: "sub_folder/index.php" - константа "sub_folder"                                         |
|                           |                                                                                                  |
|                           | Данная константа используется только для корректного получения значения константы                |
|                           | :ref:`const_BASE_PATH`. Если своевременно не определить данную константу, то ссылки,             |
|                           | построенные при помощи метода ``kApplicaton::HREF`` будут некорректными.                         |
+---------------------------+--------------------------------------------------------------------------------------------------+
| .. config-property::      | .. versionchanged:: 4.3.9                                                                        |
|    :name: SERVER_NAME     |                                                                                                  |
|    :ref_prefix: const_    |    Добавлена функциональность работающая в случае, когда не удалось получить имя виртуального    |
|                           |    хоста.                                                                                        |
|                           |                                                                                                  |
|                           | Имя виртуального хоста (``VirtualHost``), под которым запущен данный сайт (содержание переменной |
|                           | `$_SERVER['SERVER_NAME'] <http://lv.php.net/reserved.variables>`__). В случае, если название     |
|                           | виртуального хоста получить не удалось, то будет использован хост, указанный в константе         |
|                           | :ref:`const_DOMAIN` (из файла ``config.php``).                                                   |
+---------------------------+--------------------------------------------------------------------------------------------------+
| .. config-property::      | Содержание констант :ref:`const_FULL_PATH` и :ref:`const_WRITEABLE_BASE` вместе.                 |
|    :name: WRITEABLE       |                                                                                                  |
|    :ref_prefix: const_    |                                                                                                  |
+---------------------------+--------------------------------------------------------------------------------------------------+
| .. config-property::      | Максимальный размер файла, который можно загрузить на сервер (в байтах).                         |
|    :name: MAX_UPLOAD_SIZE |                                                                                                  |
|    :ref_prefix: const_    |                                                                                                  |
+---------------------------+--------------------------------------------------------------------------------------------------+

.. include:: /includes/needs_refactoring.rst

.. caution::

   Константы :ref:`const_WRITEABLE` и :ref:`const_WRITEABLE_BASE` неправильно названы. По английски они правильно
   должны называться ``WRITABLE`` и ``WRITABLE_BASE`` соответственно.

.. admonition:: Пример:

   Путь в web browser: ``http://alex.prod.intechnic.lv/test_project``.

   - ``FULL_PATH`` - "/home/sites/alex/web/test_project"
   - ``BASE_PATH`` - "/test_project"
   - ``SERVER_NAME`` - "alex.prod.intechnic.lv"
   - ``WRITEBALE_BASE`` - "/system"
   - ``WRITEBALE`` - "/home/sites/alex/web/test_project/system"

Константы общего применения
===========================

 - распространённые типы записей (статусы) в базе данных:

+---------------------------+----------------------------------------------+----------+
| название                  | описание                                     | значение |
+===========================+==============================================+==========+
| .. config-property::      | Запись активна.                              | 1        |
|    :name: STATUS_ACTIVE   |                                              |          |
|    :ref_prefix: const_    |                                              |          |
+---------------------------+----------------------------------------------+----------+
| .. config-property::      | Запись не активна.                           | 0        |
|    :name: STATUS_DISABLED |                                              |          |
|    :ref_prefix: const_    |                                              |          |
+---------------------------+----------------------------------------------+----------+
| .. config-property::      | Запись требует подтверждения администратора. | -2       |
|    :name: STATUS_PENDING  |                                              |          |
|    :ref_prefix: const_    |                                              |          |
+---------------------------+----------------------------------------------+----------+

 - статусы секций в дереве в административной консоли:

+------------------------+-------------------------------------------------------------------------+
| название               | описание                                                                |
+========================+=========================================================================+
| .. config-property::   | Секция присутствует только в дереве (почти все секции).                 |
|    :name: stTREE       |                                                                         |
|    :ref_prefix: const_ |                                                                         |
+------------------------+-------------------------------------------------------------------------+
| .. config-property::   | Секция присутствует только как закладка (см. в                          |
|    :name: stTAB        | `In-Commerce:Discounts & Coupons <In-Commerce:Discounts_&_Coupons>`__). |
|    :ref_prefix: const_ |                                                                         |
+------------------------+-------------------------------------------------------------------------+

 - статусы завершения :doc:`событий </components/event_handler/event_handlers>` в K4:

+------------------------+-----------------------------------------------------------------------------------------------------+
| название               | описание                                                                                            |
+========================+=====================================================================================================+
| .. config-property::   | Событие успешно завершило своё выполнение. После выполнения события будет сделано перенаправление,  |
|    :name: erSUCCESS    | выполняемое для того, чтобы пользователь перезагрузив страницу (F5) повторно не вызвал это событие. |
|    :ref_prefix: const_ |                                                                                                     |
+------------------------+-----------------------------------------------------------------------------------------------------+
| .. config-property::   | Событие завершило свою работу, но не выполнило одну или более требуемых задач. Перенаправление      |
|    :name: erFAIL       | происходить не будет.                                                                               |
|    :ref_prefix: const_ |                                                                                                     |
+------------------------+-----------------------------------------------------------------------------------------------------+
| .. config-property::   | Событие полностью не сделало свою работу (:doc:`хуки </components/unit_configs/hooks>` не будут     |
|    :name: erFATAL      | выполняться). Перенаправление происходить не будет.                                                 |
|    :ref_prefix: const_ |                                                                                                     |
+------------------------+-----------------------------------------------------------------------------------------------------+
| .. config-property::   | Проверка :doc:`прав доступа </components/using_permissions>` не прошла успешно. Автоматически       |
|    :name: erPERM_FAIL  | будет выполнено перенаправление на шаблон сообщающий пользователю об отсутствии у него прав на      |
|    :ref_prefix: const_ | данное событие.                                                                                     |
+------------------------+-----------------------------------------------------------------------------------------------------+
| .. config-property::   | Событие возвращает ответ в `AJAX <K4:Ajax>`__ запрос. Шаблон не будет обработан после выполнения    |
|    :name: erSTOP       | события, код отладчика тоже добавлен не будет.                                                      |
|    :ref_prefix: const_ |                                                                                                     |
+------------------------+-----------------------------------------------------------------------------------------------------+

 - константы, использующиеся при редактировании содержания сайта через административную консоль.

+-------------------------------+------------------------------------------------------------------------------------------------+
| название                      | описание                                                                                       |
+===============================+================================================================================================+
| .. config-property::          | .. versionadded:: 5.0.0                                                                        |
|    :name: EDITING_MODE        |                                                                                                |
|    :ref_prefix: const_        | Данная константа заменяет собой методы ``EditMode`` в обработчике событий и тэгов префикса     |
|                               | ``st`` и ``cms``. Значение этой константы может быть равно значению описанных ниже 3           |
|                               | констант или нулю, что будет означать, что пользователь не находиться в режиме редактирования  |
|                               | содержания сайта. В независимости от режима редактирования содержания сайта оранжевые кнопки   |
|                               | ``Edit`` будут появляться над теми фрагментами содержания страницы, которые можно изменить.    |
+-------------------------------+------------------------------------------------------------------------------------------------+
| .. config-property::          | .. versionadded:: 5.0.0                                                                        |
|    :name: EDITING_MODE_CMS    |                                                                                                |
|    :ref_prefix: const_        | Режим редактирования сайта, при котором изменяться может только содержание cms-блоков (это     |
|                               | был единственный возможный режим редактирования сайта до v5.0.0).                              |
+-------------------------------+------------------------------------------------------------------------------------------------+
| .. config-property::          | .. versionadded:: 5.0.0                                                                        |
|    :name: EDITING_MODE_LAYOUT |                                                                                                |
|    :ref_prefix: const_        | Режим редактирования сайта, при котором изменяться может изменяться только содержание блоков,  |
|                               | при подключении которых был передан параметр ``layout_view``:                                  |
|                               |                                                                                                |
|                               | .. code:: xml                                                                                  |
|                               |                                                                                                |
|                               |    <inp2:m_RenderElement name="block_name" layout_view="1"/>                                   |
|                               |                                                                                                |
|                               | В :doc:`теме </database/table_structure/theme>` ``default2007`` это блоки ``sidebar`` и        |
|                               | ``content`` из текущего шаблона.                                                               |
+-------------------------------+------------------------------------------------------------------------------------------------+
| .. config-property::          | .. versionadded:: 5.0.0                                                                        |
|    :name: EDITING_MODE_DESIGN |                                                                                                |
|    :ref_prefix: const_        | Режим редактирования сайта, при котором изменяться может только дизайн показываемых на шаблоне |
|                               | блоков, т.е. блоков, которые были указаны в параметре ``design`` (в примере это                |
|                               | ``design_block_name``) при подключении других (в примере это ``element_name``)                 |
|                               | блоков. Например:                                                                              |
|                               |                                                                                                |
|                               | .. code:: xml                                                                                  |
|                               |                                                                                                |
|                               |    <inp2:m_RenderElement name="element_name" design="design_block_name"/>                      |
|                               |                                                                                                |
|                               | В :doc:`теме </database/table_structure/theme>` ``default2007`` это блоки ``blue_box`` и       |
|                               | ``content_box``.                                                                               |
+-------------------------------+------------------------------------------------------------------------------------------------+

 - разное:

+----------------------------------+---------------------------------------------------------------------------------------------+--------------------------------------------------+
| название                         | описание                                                                                    | значение                                         |
+==================================+=============================================================================================+==================================================+
| .. config-property::             | Значение данной константы используется для определения названия                             | ``env``                                          |
|    :name: ENV_VAR_NAME           | :doc:`переменной окружения </application_structure/environment_variable>`                   |                                                  |
|    :ref_prefix: const_           | в запросе к серверу.                                                                        |                                                  |
+----------------------------------+---------------------------------------------------------------------------------------------+--------------------------------------------------+
| .. config-property::             | Значение, которое будет использоваться для объединения :ref:`возможных                      | ``||``                                           |
|    :name: VALUE_LIST_SEPARATOR   | опций <fmt_options>` в полях ``ValueList`` (во всех таблицах,                               |                                                  |
|    :ref_prefix: const_           | кроме таблицы :doc:`/database/table_structure/configuration_admin`).                        |                                                  |
+----------------------------------+---------------------------------------------------------------------------------------------+--------------------------------------------------+
| .. config-property::             | .. versionadded:: 4.0.1                                                                     | ``[-a-zA-Z0-9!\#$%&*+\/=?^_`{|}~.]+``            |
|    :name: REGEX_EMAIL_USER       |                                                                                             |                                                  |
|    :ref_prefix: const_           | Регулярное выражение, которое проверяет части с именем пользователя в                       |                                                  |
|                                  | адресе электронной почты (``email``). Используя константы                                   |                                                  |
|                                  | :ref:`const_REGEX_EMAIL_USER` и :ref:`const_REGEX_EMAIL_DOMAIN` можно составить регулярное  |                                                  |
|                                  | выражение для проверки адреса электронной почты:                                            |                                                  |
|                                  |                                                                                             |                                                  |
|                                  | .. code:: php                                                                               |                                                  |
|                                  |                                                                                             |                                                  |
|                                  |    $regexp = '/^(' . REGEX_EMAIL_USER . '@' . REGEX_EMAIL_DOMAIN . ')$/i';                  |                                                  |
+----------------------------------+---------------------------------------------------------------------------------------------+--------------------------------------------------+
| .. config-property::             | .. versionadded:: 4.0.1                                                                     | ``[a-zA-Z0-9]{1}[-.a-zA-Z0-9_]*\.[a-zA-Z]{2,6}`` |
|    :name: REGEX_EMAIL_DOMAIN     |                                                                                             |                                                  |
|    :ref_prefix: const_           | Регулярное выражение, которое проверяет части с доменом (``domain``) в адресе               |                                                  |
|                                  | электронной почты (``email``). Используя константы                                          |                                                  |
|                                  | :ref:`const_REGEX_EMAIL_USER` и :ref:`const_REGEX_EMAIL_DOMAIN` можно составить регулярное  |                                                  |
|                                  | выражение для проверки адреса электронной почты:                                            |                                                  |
|                                  |                                                                                             |                                                  |
|                                  | .. code:: php                                                                               |                                                  |
|                                  |                                                                                             |                                                  |
|                                  |    $regexp = '/^(' . REGEX_EMAIL_USER . '@' . REGEX_EMAIL_DOMAIN . ')$/i';                  |                                                  |
+----------------------------------+---------------------------------------------------------------------------------------------+--------------------------------------------------+
| .. config-property::             | .. versionadded:: 4.2.2                                                                     | ``_USE_DEFAULT_USER_DATA_``                      |
|    :name: ALLOW_DEFAULT_SETTINGS |                                                                                             |                                                  |
|    :ref_prefix: const_           | Данная константа задумана для передачи в метод                                              |                                                  |
|                                  | ``kApplication::RecallPersistentVar`` в качестве значения по умолчанию. Это                 |                                                  |
|                                  | подробнее показано на приведённом ниже примере.                                             |                                                  |
|                                  |                                                                                             |                                                  |
|                                  | .. code:: php                                                                               |                                                  |
|                                  |                                                                                             |                                                  |
|                                  |    $value = $this->Application->RecallPersistentVar(                                        |                                                  |
|                                  |      'VarName',                                                                             |                                                  |
|                                  |      ALLOW_DEFAULT_SETTINGS                                                                 |                                                  |
|                                  |    );                                                                                       |                                                  |
|                                  |                                                                                             |                                                  |
|                                  | Если требуемой переменной в таблице                                                         |                                                  |
|                                  | :doc:`/database/table_structure/persistant_session_data` нету и используется                |                                                  |
|                                  | эта константа, то будет возвращено значение этой переменной взятое у                        |                                                  |
|                                  | пользователя, указанного в конфигурационной переменной                                      |                                                  |
|                                  | :ref:`cfg_DefaultSettingsUserId`.                                                           |                                                  |
+----------------------------------+---------------------------------------------------------------------------------------------+--------------------------------------------------+


Константы это идентификаторы значений, которые не могут изменяться по ходу выполнения скрипта.

Константы из config.php
=======================
В базовой директории проекта (той, что в :ref:`const_FULL_PATH` константе) находиться файл ``config.php``, который
содержит настройки для подключения к базе данных и ряд других параметров, которые при инициализации K4 превращаются
в константы. На данный файл **нельзя**, не в коем случае, **делать commit**. По своему формату этот файл похож на
обычный ini файл. Единственное отличие это расширение файла и защитная php конструкция в его начале.

+-----------------------------+----------------------+-----------------------------------------------------------------------------------------------------------+
| название константы          | название опции       | описание                                                                                                  |
+=============================+======================+===========================================================================================================+
| .. config-property::        | ``DBType``           | Тип сервера баз данных. Пока поддерживается только MySQL.                                                 |
|    :name: SQL_TYPE          |                      |                                                                                                           |
|    :ref_prefix: const_      |                      |                                                                                                           |
+-----------------------------+----------------------+-----------------------------------------------------------------------------------------------------------+
| .. config-property::        | ``DBHost``           | IP адрес или имя сервера баз данных.                                                                      |
|    :name: SQL_SERVER        |                      |                                                                                                           |
|    :ref_prefix: const_      |                      |                                                                                                           |
+-----------------------------+----------------------+-----------------------------------------------------------------------------------------------------------+
| .. config-property::        | ``DBUser``           | Имя пользователя, для подключения к базе данных.                                                          |
|    :name: SQL_USER          |                      |                                                                                                           |
|    :ref_prefix: const_      |                      |                                                                                                           |
+-----------------------------+----------------------+-----------------------------------------------------------------------------------------------------------+
| .. config-property::        | ``DBUserPassword``   | Пароль, для подключения к базе данных.                                                                    |
|    :name: SQL_PASS          |                      |                                                                                                           |
|    :ref_prefix: const_      |                      |                                                                                                           |
+-----------------------------+----------------------+-----------------------------------------------------------------------------------------------------------+
| .. config-property::        | ``DBName``           | Название базы данных.                                                                                     |
|    :name: SQL_DB            |                      |                                                                                                           |
|    :ref_prefix: const_      |                      |                                                                                                           |
+-----------------------------+----------------------+-----------------------------------------------------------------------------------------------------------+
| .. config-property::        | ``DBCollation``      | Тип сопоставления строк, используемый при работе базой данных (напр. ``utf8_general_ci``).                |
|    :name: SQL_COLLATION     |                      |                                                                                                           |
|    :ref_prefix: const_      |                      |                                                                                                           |
+-----------------------------+----------------------+-----------------------------------------------------------------------------------------------------------+
| .. config-property::        | ``DBCharset``        | Кодировка данных, используемая при работе базой данных (напр. ``utf8``).                                  |
|    :name: SQL_CHARSET       |                      |                                                                                                           |
|    :ref_prefix: const_      |                      |                                                                                                           |
+-----------------------------+----------------------+-----------------------------------------------------------------------------------------------------------+
| .. config-property::        | ``TablePrefix``      | Префикс таблиц проекта в базе данных.                                                                     |
|    :name: TABLE_PREFIX      |                      |                                                                                                           |
|    :ref_prefix: const_      |                      |                                                                                                           |
+-----------------------------+----------------------+-----------------------------------------------------------------------------------------------------------+
| .. config-property::        | ``Domain``           | Домен, на котором сайт находиться. Используется для выхода из SSL-режима, а также для проверки лицензии в |
|    :name: DOMAIN            |                      | ``In-Portal``.                                                                                            |
|    :ref_prefix: const_      |                      |                                                                                                           |
+-----------------------------+----------------------+-----------------------------------------------------------------------------------------------------------+
| .. config-property::        | ``AdminDirectory``   | .. versionadded:: 4.3.0                                                                                   |
|    :name: ADMIN_DIRECTORY   |                      |                                                                                                           |
|    :ref_prefix: const_      |                      | Расположение директории с административной консолью относительно :ref:`const_FULL_PATH`.                  |
+-----------------------------+----------------------+-----------------------------------------------------------------------------------------------------------+
| .. config-property::        | ``EditorPath``       | .. versionadded:: 4.3.2                                                                                   |
|    :name: EDITOR_PATH       |                      |                                                                                                           |
|    :ref_prefix: const_      |                      | Расположение директории с ``FCKEditor`` относительно :ref:`const_FULL_PATH` (обычно ``/core/editor/``).   |
+-----------------------------+----------------------+-----------------------------------------------------------------------------------------------------------+
| .. config-property::        | ``WriteablePath``    | Директория, в которую имеет право писать сервер (обычно ``/system``).                                     |
|    :name: WRITEABLE_BASE    |                      |                                                                                                           |
|    :ref_prefix: const_      |                      |                                                                                                           |
+-----------------------------+----------------------+-----------------------------------------------------------------------------------------------------------+
| .. config-property::        | ``ApplicationClass`` | Класс, который используется для создания объекта `Application <K4:Application>`__, например               |
|    :name: APPLICATION_CLASS |                      | ``EApplication``.                                                                                         |
|    :ref_prefix: const_      |                      |                                                                                                           |
+-----------------------------+----------------------+-----------------------------------------------------------------------------------------------------------+
| .. config-property::        | ``ApplicationPath``  | Расположение файла с классом, указанным в :ref:`const_APPLICATION_CLASS` относительно корня сайта         |
|    :name: APPLICATION_PATH  |                      | (с указанием ``/`` спереди), например. ``/custom/units/sections/e_application.php``.                      |
|    :ref_prefix: const_      |                      |                                                                                                           |
+-----------------------------+----------------------+-----------------------------------------------------------------------------------------------------------+

.. _Data Source: http://guide.in-portal.org/rus/index.php/K4:%D0%9A%D0%BE%D0%BD%D1%81%D1%82%D0%B0%D0%BD%D1%82%D1%8B
.. _Eng Data Source: http://guide.in-portal.org/eng/index.php/K4:Constants
.. _Confluence: http://community.in-portal.org/pages/viewpage.action?pageId=14155811

.. include:: /includes/broken_links.rst

.. Broken Links:
   =============
   In-Commerce:Discounts_&_Coupons
   K4:Ajax
   K4:Application
