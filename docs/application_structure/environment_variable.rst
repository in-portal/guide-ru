Переменная окружения
********************
`Data Source`_ `Eng Data Source`_ `Confluence`_

Переменная окружения представляет из себя обычную переменную из запроса к серверу с названием ``env``. Само название
данной переменной задано в константе :ref:`const_ENV_VAR_NAME`. Она была введена для того, чтобы реализовать
возможность компактной передачи большого количества переменных между страницами сайта. В большинстве случаев в ней
будет содержаться информация, при помощи которой можно будет загрузить объект из
:doc:`базы данных </database/using_database>` на странице (т.е. :ref:`префикс <uc_Prefix>` и ``ID``), но
это совсем не обязательно.

Если в |unit_config_link| переданного :ref:`префикса <uc_Prefix>` разрешена
:ref:`автоматическая загрузка <uc_AutoLoad>`, то при первом обращении к объекту :ref:`префикс <uc_Prefix>` которого
передан и при наличии его ``ID`` в запросе к серверу он будет автоматически загружен.

.. _env_var_structure:

Структура
=========

Значение, содержащееся в переменной окружения имеет следующую структуру:

.. code:: bash

   <session_id>-<template>:m<main_prefix_variables>[:<prefix[.special]>-<value1>[-<value2>...[-<valueN>]]]

Как видно из приведённой выше схемы в переменной окружения всегда присутствуют следующие компоненты:

- ``session_id`` - :ref:`идентификатор сессии <tc_UserSession_SessionKey>`
  :doc:`пользователя </database/table_structure/portal_user>`;
- ``template`` - путь к шаблону, результат обработки которого будет показан на экране;
- ``main_prefix_variables`` - ряд системных переменных, среди которых в том числе присутствуют
  :ref:`ID темы <tc_Theme_ThemeId>` и :ref:`ID языка <tc_Language_LanguageId>`, которые будут
  использованы для вывода информации на странице (об этом позже).

Также в ней могут присутствовать данные неограниченного количества :ref:`префиксов <uc_Prefix>`.
Наборы данных разных префиксов друг от друга отделяются двоеточием (``:``). Первое значение внутри
каждого набора - префикс конфигурационного файла. Если необходимо, то можно указать и ``special``
следующим образом: ``prefix.special``.

Далее следует список параметров префикса, которые могут передаваться через переменную окружения,
разделённых при помощи дефиса (``-``). Названия параметров, а также их порядок в пределах одного
набора префикса задаётся в ключе :ref:`uc_QueryString` его :doc:`конфигурационного
файла </components/unit_configs/config_files>`. Например:

.. code:: php

   'QueryString' => Array(
       1 => 'id',
       2 => 'Page',
       3 => 'event',
       4 => 'mode',
   ),

Приведённое выше значение ключа :ref:`uc_QueryString` является стандартным для большинства
:ref:`префиксов <uc_Prefix>` и поэтому будет описано ниже.

+-----------+---------------------------------------------------------------------------------------------------------+
| название  | описание                                                                                                |
+===========+=========================================================================================================+
| ``id``    | ID объекта (``Item``), которое может быть использовано для                                              |
|           | :ref:`автоматической загрузки <uc_AutoLoad>` объекта.                                                   |
+-----------+---------------------------------------------------------------------------------------------------------+
| ``Page``  | Номер страницы списка объектов (``List``).                                                              |
+-----------+---------------------------------------------------------------------------------------------------------+
| ``event`` | :doc:`Событие </events>`, которое требуется выполнить у данного :ref:`префикса <uc_Prefix>`.            |
+-----------+---------------------------------------------------------------------------------------------------------+
| ``mode``  | Режим редактирования записей. Возможны 3 вида значений:                                                 |
|           |                                                                                                         |
|           | - ``""`` - данные будут редактироваться в оригинальной таблице;                                         |
|           | - ``"t"`` - данные будут редактироваться во временной таблице в основном окне;                          |
|           | - ``"t<wid>"`` - данные будут редактироваться во временной таблице, которая была создана при открытии   |
|           |   всплывающего окна (``popup``) с идентификатором окна (``window id``) равным ``<wid>``.                |
+-----------+---------------------------------------------------------------------------------------------------------+

.. attention::

   Значения данного массива чувствительны к регистру (``case-sensitive``).

.. _получение_данных_из_переменной_окружения:

Получение данных из переменной окружения
========================================

Если в ссылке, используемой для посещения сайта находиться переменная окружения, то её значение будет автоматически
обработано системой. Доступ напрямую к значению переменной окружения не рекомендуется. В результате обработки
**для каждого** из переданных :ref:`префиксов <uc_Prefix>` будут искусственно созданы переменные вида
``prefix[.special]_VariableName``. Будет создано по одной переменной для каждого **значения** в массиве
:ref:`uc_QueryString` у переданного префикса. Созданные таким образом переменные можно будет в последствии использовать
также, как и любые другие переменные, переданные в запросе к серверу (т.е. при помощи метода ``Application::GetVar``).
Это будет наглядно показано на ниже приведённом примере.

- Переменные, заданные в |unit_config_link|:

.. code:: php

   'Prefix' => 'sample-prefix',
   'QueryString' => Array (
       1 => 'sample_variable',
       2 => 'another_variable',
   ),

- Значение переменной окружения:

.. code:: html

   -template:m0--1--s-:sample\-prefix-15-testing

В выше приведённом примере у префикса ``sample-prefix`` в |unit_config_link| определены 2 переменные:
``sample_variable`` и ``another_variable``. В переменной окружения для данного префикса переданы значения этих
переменных, равные ``15`` и ``testing`` соответственно. После обработки переменной окружения для данного префикса
будут созданы 2 переменные:

================================== ===========
название                           значение
================================== ===========
``sample-prefix_sample_variable``  ``15``
``sample-prefix_another_variable`` ``testing``
================================== ===========

.. note::

   Переменная будет создана, даже если её значение не передано.

Получить значение любой из созданных выше переменных можно будет используя код вида:

+---------------------------------------------------+--------------------------------------------------------------+
| пример для ``PHP``                                | пример для шаблона                                           |
+===================================================+==============================================================+
| .. code:: php                                     | .. code:: html                                               |
|                                                   |                                                              |
|    $sample_variable = $this->Application->GetVar( |    value: <inp2:m_Get name="sample-prefix_sample_variable"/> |
|      'sample-prefix_sample_variable'              |                                                              |
|    );                                             |                                                              |
+---------------------------------------------------+--------------------------------------------------------------+

.. note::

   Чтобы не "зашивать" значение префикса в коде его можно получить динамически используя методы
   ``kEvent::getPrefixSpecial()`` (для :doc:`событий </events>`) и ``TagProcessor:getPrefixSpecial()``
   (для :doc:`тэгов </themes_and_templates/working_with_templates>`).

.. _env_var_link_building:

Построение ссылок
=================

Т.к. переменная окружения используется только для компактной передачи данных между страницами сайта, то единственным
способом в неё что-либо записать является построение ссылки. Все ссылки в K4 строятся используя метод
``Application::HREF``. Например он используется в методе ``Application::Redirect``, а также в
:doc:`тэгах </themes_and_templates/working_with_templates>` :doc:`/tags/m_link`, :doc:`/tags/st_content_block`,
:doc:`/tags/lang_language_link` и :doc:`/tags/m_form_action`. Этот метод принимает 4 описанных ниже параметра.

+-----------------------+-----------------------------------------------------------------------------------------------------+
| параметр              | описание                                                                                            |
+=======================+=====================================================================================================+
| .. config-property::  | Название шаблона, ссылку на который требуется построить (напр. ``custom/tests/test_edit``).         |
|    :name: $t          | Параметр обязательный, но если передать пустое значение, то будет использован текущий (тот,         |
|    :type: string      | на который зашёл пользователь) шаблон.                                                              |
+-----------------------+-----------------------------------------------------------------------------------------------------+
| .. config-property::  | Данный необязательный параметр предназначен для того, чтобы можно было находясь в                   |
|    :name: $prefix     | административной консоли построить ссылку на пользовательскую часть сайта. Для того, чтобы          |
|    :type: string      | это сделать нужно передать в него значение ``_FRONT_END_``.                                         |
|                       |                                                                                                     |
|                       | .. warning::                                                                                        |
|                       |                                                                                                     |
|                       |    На текущий момент данная функциональность не работает. Чтобы построить ссылку на                 |
|                       |    пользовательскую часть сайта нужно передать ``index.php`` в качестве значения параметра          |
|                       |    :ref:`url_index_file`.                                                                           |
+-----------------------+-----------------------------------------------------------------------------------------------------+
| .. config-property::  | Набор параметров, которые следует передать в ссылку. Помимо параметров общего применения            |
|    :name: $params     | можно также передать ряд параметров специального назначения, описанных                              |
|    :type: array       | :ref:`ниже <env_var_special_params>`.                                                               |
+-----------------------+-----------------------------------------------------------------------------------------------------+
| .. config-property::  | Необязательное название ``php`` файла, который следует использовать в результирующей ссылке.        |
|    :name: $index_file | По умолчанию равен ``index.php`` (для пользовательской части сайта) и ``admin/index.php``           |
|    :type: string      | (для административной консоли).                                                                     |
+-----------------------+-----------------------------------------------------------------------------------------------------+

.. _env_var_special_params:

Параметры специального назначения
---------------------------------

+----------------------+--------------------------------------------------------------------------------------------------------------------------+
| параметр             | описание                                                                                                                 |
+======================+==========================================================================================================================+
| .. config-property:: | В данном параметре передаются названия тех :ref:`префиксов <uc_Prefix>` (через запятую),                                 |
|    :name: pass       | которые будут использоваться при построении значения переменной окружения в результирующей                               |
|    :type: string     | ссылке. Также можно передать значение ``all``, чтобы были использованы все                                               |
|    :ref_prefix: url_ | :ref:`префиксы <uc_Prefix>` из ссылки на текущую страницу сайта. Например, ``m,sample-prefix``                           |
|                      | или ``all``.                                                                                                             |
|                      |                                                                                                                          |
|                      | .. note::                                                                                                                |
|                      |                                                                                                                          |
|                      |    Также следует отметить, что **всегда**, когда указывается список префиксов первым из них                              |
|                      |    должен быть :ref:`префикс <uc_Prefix>` "m".                                                                           |
+----------------------+--------------------------------------------------------------------------------------------------------------------------+
| .. config-property:: | Альтернативный способ задания значения параметра ``index_file`` методу ``Application::HREF``                             |
|    :name: index_file | через шаблон. Например (если передать ``another_index.php``):                                                            |
|    :type: string     |                                                                                                                          |
|    :ref_prefix: url_ | .. code::                                                                                                                |
|                      |                                                                                                                          |
|                      |    с параметром:                                                                                                         |
|                      |    http://www.sample-site.com/another_index.php?env=-template:m0--1--s-                                                  |
|                      |                                                                                                                          |
|                      |    без параметра:                                                                                                        |
|                      |    http://www.sample-site.com/index.php?env=-template:m0--1--s-                                                          |
+----------------------+--------------------------------------------------------------------------------------------------------------------------+
| .. config-property:: | Если указать данный параметр, то на результирующую ссылку будет применена функция                                        |
|    :name: escape     | `addslashes <https://www.php.net/addslashes>`__. Только при использовании на шаблонах                                    |
|    :type: int        | вместо данного параметра следует использовать параметр ``js_escape``, т.к. он является                                   |
|    :ref_prefix: url_ | усовершенствованной версией данного параметра и будет работать для всех тэгов.                                           |
|                      | Например (если передать ``1``):                                                                                          |
|                      |                                                                                                                          |
|                      | .. code::                                                                                                                |
|                      |                                                                                                                          |
|                      |    с параметром:                                                                                                         |
|                      |    http://www.sample-site.com/index.php?env=-template:m0--1--s-:sample\\-prefix-15-testing                               |
|                      |                                                                                                                          |
|                      |    без параметра:                                                                                                        |
|                      |    http://www.sample-site.com/index.php?env=-template:m0--1--s-:sample\-prefix-15-testing                                |
|                      |                                                                                                                          |
|                      | Обычно параметр ``js_escape`` (в шаблонах) следует использовать для построения ссылок, используемых в                    |
|                      | ``JavaScript``.                                                                                                          |
+----------------------+--------------------------------------------------------------------------------------------------------------------------+
| .. config-property:: | Данный параметр позволяет добавить указанное в нём значение, как якорь к результирующей ссылке.                          |
|    :name: anchor     | Например (если передать ``sample_anchor``):                                                                              |
|    :type: string     |                                                                                                                          |
|    :ref_prefix: url_ | .. code::                                                                                                                |
|                      |                                                                                                                          |
|                      |    с параметром:                                                                                                         |
|                      |    http://www.sample-site.com/index.php?env=-template:m0--1--s-#sample_anchor                                            |
|                      |                                                                                                                          |
|                      |    без параметра:                                                                                                        |
|                      |    http://www.sample-site.com/index.php?env=-template:m0--1--s-                                                          |
+----------------------+--------------------------------------------------------------------------------------------------------------------------+
| .. config-property:: | Если передать данный параметр, то все переменные, используемые в результирующей ссылке будут объединены                  |
|    :name: no_amp     | используя символ ``&`` (совместимо с ``JavaScript``). Во всех остальных случаях переменные будут                         |
|    :type: int        | объединены при помощи строки ``&amp;`` (совместимо с ``HTML``). Например (если передать ``1``):                          |
|    :ref_prefix: url_ |                                                                                                                          |
|                      | .. code::                                                                                                                |
|                      |                                                                                                                          |
|                      |    с параметром                                                                                                          |
|                      |    http://www.sample-site.com/index.php?env=-template:m0--1--s-&amp;sample_parameter=value1&amp;another_parameter=value2 |
|                      |                                                                                                                          |
|                      |    без параметра:                                                                                                        |
|                      |    http://www.sample-site.com/index.php?env=-template:m0--1--s-&sample_parameter=value1&another_parameter=value2         |
+----------------------+--------------------------------------------------------------------------------------------------------------------------+

Использование переданных параметров
-----------------------------------

Сначала все переданные параметры делятся на **3 группы**:

- параметры :ref:`специального назначения <env_var_special_params>`;
- параметры, которые будут использоваться в :ref:`переменной окружения <env_var_structure>`;
- остальные параметры.

Берётся список :ref:`префиксов <uc_Prefix>` из значения параметра :ref:`url_pass` и для каждого префикса
выстраивается :ref:`фрагмент <env_var_structure>` переменной окружения, который будет его представлять. В случае,
если значение той или иной :ref:`переменной префикса <env_var_structure>` не задано в параметрах, то берётся значение,
полученное из запроса к серверу или пустая строка, если ничего передано не было. Все параметры, которые
**были использованы** при построении значения переменной окружения убираются из общего списка параметров
(чтобы они не попали в результирующую ссылку).

Остальные, не использованные в переменной окружения параметры (кроме параметров
:ref:`специального назначения <env_var_special_params>`) добавляются к результирующей ссылке используя
строку ``&amp;`` или ``&`` (если используется параметр специального назначения :ref:`url_no_amp`).

После выполнения всех выше описанных шагов на полученную ссылку применяются переданные параметры
:ref:`специального назначения <env_var_special_params>`.

Запись данных
=============

Запись значений в переменную окружения из шаблонов сводится к формированию ссылки, по которой в последствии
перейдёт пользователь. Формирование ссылок внутри шаблонов производится с помощью тэга :doc:`/tags/m_link`.
В ниже приведённом примере продемонстрировано его использование.

Запись данных из шаблонов
-------------------------

.. code:: html

   <a href="<inp2:m_Link template='cart' cart_event='OnAddProduct' pass='m,cart,product'/>">Add To Cart</a>

Ниже приведено описание параметров тэга :doc:`/tags/m_link`, использованных в выше приведённом примере.

+----------------------+----------------------------------------------------------------------------------------------+
| параметр             | пояснение                                                                                    |
+======================+==============================================================================================+
| .. config-property:: | Путь к шаблону. В пользовательской части сайта это путь относительно директории              |
|    :name: template   | с :doc:`темой </database/table_structure/theme>`.                                            |
|    :type: string     |                                                                                              |
+----------------------+----------------------------------------------------------------------------------------------+
| .. config-property:: | Название :doc:`события </events>` для префикса ``cart``. Указанное событие                   |
|    :name: cart_event | будет выполнено только в том случае, когда префикс ``cart`` указан в параметре ``pass``.     |
|    :type: string     |                                                                                              |
+----------------------+----------------------------------------------------------------------------------------------+
| .. config-property:: | Параметр указывает на то, данные каких префиксов необходимо передать в переменной окружения. |
|    :name: pass       |                                                                                              |
|    :type: string     |                                                                                              |
+----------------------+----------------------------------------------------------------------------------------------+

Запись данных из событий
------------------------

После успешного выполнения каждого :doc:`события </events>` происходит автоматическое перенаправление на шаблон,
с которого данное событие было вызвано. Для того, чтобы в ссылке построенной для этого перенаправления присутствовали
дополнительные параметры нужно использовать метод ``kEvent:setRedirectParam``. В свою очередь свойство
``kEvent:redirect`` позволит задать альтернативный шаблон, использующийся в ссылке на перенаправление. Это будет
наглядно показано на ниже приведённом примере.

.. code:: php

   function OnCreate(&$event)
   {
       parent::OnCreate($event);

       if ($event->status == erSUCCESS) {
           return ;
       }


       $event->redirect = 'alternative_destination_template';
       $event->setRedirectParam('pass', 'm,test');
       $event->setRedirectParam('param_name', 'param_value');
   }

В данном примере значение переменной ``param_name`` будет доступно на шаблоне ``alternative_destination_template``.
Подробнее о последующем получении значений переданных параметров написано в
:ref:`этой, выше описанной главе <получение_данных_из_переменной_окружения>`.

Системные переменные окружения
==============================

Помимо данных от пользовательских :ref:`префиксов <uc_Prefix>` в переменной окружения всегда передаётся префикс
``m`` (``main``), содержащий системные переменные окружения. Конфигурационный файл от данного префикса находиться
в папке ``core/units/general`` и соответственно называется ``general_config.php`` (название папки плюс ``_config.php``).
В данном конфигурационном файле используется ключ :ref:`uc_PortalStyleEnv`, из-за которого в результирующей переменной
окружения для данного префикса не будет дефиса (``-``) между названием префикса и значением его первой переменной
(т.е. ``m5``, а не ``m-5`` как обычно). При помощи данного префикса передаются следующие переменные:

+----------------------+---------------------------------------------------------------------------------------------------------------+
| название             | описание                                                                                                      |
+======================+===============================================================================================================+
| .. config-property:: | :ref:`ID текущей категории <tc_Category_CategoryId>`, т.е. той категории, данные из                           |
|    :name: m_cat_id   | которой пользователь просматривает в данный момент.                                                           |
|    :type: int        |                                                                                                               |
|    :ref_prefix: env_ |                                                                                                               |
+----------------------+---------------------------------------------------------------------------------------------------------------+
| .. config-property:: | Номер страницы в списке категорий, находящихся в категории, заданной в                                        |
|    :name: m_cat_page | переменной :ref:`env_m_cat_id`.                                                                               |
|    :type: int        |                                                                                                               |
|    :ref_prefix: env_ |                                                                                                               |
+----------------------+---------------------------------------------------------------------------------------------------------------+
| .. config-property:: | :ref:`ID языка <tc_Language_LanguageId>`, на котором нужно показывать                                         |
|    :name: m_lang     | содержание сайта (также работает и в административной консоли). Если                                          |
|    :type: int        | не задать, то будет использовано :ref:`ID основного языка <tc_Language_PrimaryLang>`, заданное                |
|    :ref_prefix: env_ | в |sections_link| ``Configuration -> Regional``.                                                              |
+----------------------+---------------------------------------------------------------------------------------------------------------+
| .. config-property:: | :ref:`ID темы <tc_Theme_ThemeId>`, которую нужно использовать для показывания пользовательской                |
|    :name: m_theme    | части сайта. Значение данной переменной не используется в административной консоли. Если не                   |
|    :type: int        | задать, то будет использовано :ref:`ID основной темы <tc_Theme_PrimaryTheme>`, заданное в                     |
|    :ref_prefix: env_ | |sections_link| ``Configuration -> Themes``.                                                                  |
+----------------------+---------------------------------------------------------------------------------------------------------------+
| .. config-property:: | Данная переменная используется для того, чтобы после при нажатии на кнопки ``Save``                           |
|    :name: m_opener   | (события :doc:`/events/temp_editing/on_save`, :doc:`/events/live_editing/on_create`,                          |
|    :type: int        | :doc:`/events/live_editing/on_update`) и "``Cancel``" (события                                                |
|    :ref_prefix: env_ | :doc:`/events/temp_editing/on_cancel_edit`, :doc:`/events/live_editing/on_cancel`)                            |
|                      | на панели инструментов на формах редактирования автоматически происходил возврат на тот                       |
|                      | шаблон, с которого пользователь попал на эту форму редактирования. Для этого используется                     |
|                      | массив ``opener_stack_<m_wid>``, содержащий шаблоны, заходя на которые пользователь в                         |
|                      | итоге попал на данный шаблон (напр. ``Array ('users/user_list', 'users/user_edit_groups');``).                |
|                      |                                                                                                               |
|                      | .. note::                                                                                                     |
|                      |                                                                                                               |
|                      |    Последним элементом в этом массиве будет шаблон, с которого пользователь попал на текущий.                 |
|                      |                                                                                                               |
|                      | Данный массив храниться в :doc:`сессии </database/table_structure/session_data>`. Значение,                   |
|                      | переданное в данной переменной будет рассматриваться как команда к изменению содержания                       |
|                      | массива ``opener_stack_<m_wid>`` для текущего окна:                                                           |
|                      |                                                                                                               |
|                      | - ``r`` (reset) - стереть массив (используется для построения ссылок для                                      |
|                      |   :doc:`секций </admin_console_ui/templates_and_blocks/tree_sections>` в дереве);                             |
|                      | - ``d`` (down) - добавить текущий шаблон в массив (используется при переходе на шаблон                        |
|                      |   редактирования записи с шаблона списка записей);                                                            |
|                      | - ``u`` (up) - удалить последний шаблон из массива (используется при возвращении с шаблона                    |
|                      |   редактирования записи на шаблон списка записей);                                                            |
|                      | - ``p`` (popup) - добавить текущий шаблон в массив и создать новый                                            |
|                      |   :ref:`идентификатор окна <env_m_wid>` (тоже самое, что ``d``, но только с поправкой на то,                  |
|                      |   что форма редактирования будет открыта в новом всплывающем окне);                                           |
|                      | - ``s`` (stay) - ничего не делать с массивом (значение по умолчанию).                                         |
+----------------------+---------------------------------------------------------------------------------------------------------------+
| .. config-property:: | Идентификатор окна, который используется только для всплывающих окон (``popups``). Для основного              |
|    :name: m_wid      | окна значение данной переменной равно пустоте. Также идентификатор окна используется в формировании           |
|    :type: int        | названия массива ``opener_stack_<m_wid>``, управляемого через значение переменной :ref:`env_m_opener`.        |
|    :ref_prefix: env_ |                                                                                                               |
+----------------------+---------------------------------------------------------------------------------------------------------------+

.. _Data Source: http://guide.in-portal.org/rus/index.php/K4:%D0%9F%D0%B5%D1%80%D0%B5%D0%BC%D0%B5%D0%BD%D0%BD%D0%B0%D1%8F_%D0%BE%D0%BA%D1%80%D1%83%D0%B6%D0%B5%D0%BD%D0%B8%D1%8F
.. _Eng Data Source: http://guide.in-portal.org/eng/index.php/K4:Environment_Variable
.. _Confluence: http://community.in-portal.org/pages/viewpage.action?pageId=14155813

.. |unit_config_link| replace:: :doc:`конфигурационном файле </components/unit_configs/config_files>`
.. |sections_link| replace:: :doc:`секции </admin_console_ui/templates_and_blocks/tree_sections>`
