Как включить SSL-режим
**********************
`Data Source`_ `Eng Data Source`_ `Confluence`_

Перед настройкой протокола нужно, что бы на сервере был установлен действительный (valid) SSL-сертификат.

============================== =================================
действительный SSL-сертификат  не действительный SSL-сертификат
============================== =================================
|ssl valid|                    |ssl error|
============================== =================================

.. |ssl valid| image:: /images/Ssl_valid.jpg
   :width: 180px
   :alt: действительный SSL-сертификат

.. |ssl error| image:: /images/Ssl_error.jpg
   :width: 180px
   :alt: не действительный SSL-сертификат

В приведённой выше таблице можно увидеть как выгладит окно браузера, в случает когда установлен
действительный SSL-сертификат и в случае, когда SSL-сертификат не действителен (напр. выдан другому сайту).

Общие положения
===============
Все требуемые для настройки :doc:`конфигурационные переменные </system_setup/configuration_variables>` находятся
в разделе ``Configuration -> System Variables`` административной консоли сайта. Независимо о того для какой части
сайта настраивается SSL всегда требуется указать значение конфигурационной переменной :ref:`cfg_SSL_URL`
("SSL Full URL (https://www.domain.com/path)").

SSL для административной консоли
================================
.. figure:: /images/Ssl_admin.jpg
   :figwidth: 180px
   :width: 180px
   :align: left
   :alt: Административная консоль в режиме SSL

   Административная консоль в режиме SSL

Для подключения SSL к административной консоли требуется включить конфигурационную переменную
:ref:`cfg_Require_AdminSSL` ("Require SSL for Administrative Console"). Далее нажимаем кнопку ``Save`` на панели
инструментов и выходим из системы (``logout``). На странице ввода имени пользователя и пароля должны увидеть то,
что обведено на приведённом слева изображении. Вот и все – протокол успешно настроен для административной консоли.

.. clear-float::

SSL для пользовательской части сайта
====================================
Для подключения SSL к пользовательской части сайта требуется включить некоторые (в зависимости от функциональности
настраиваемого сайта) из ниже приведённых конфигурационных переменных:

+-----------------------------------------------+-------------------------------------------------------------------------+
| конфигурационная переменная                   | описание                                                                |
+===============================================+=========================================================================+
| :ref:`cfg_Require_SSL`                        | Включение SSL режима для страниц сайта, где в html коде шаблона         |
| ("Require SSL for login & checkout")          | прописан тег                                                            |
+-----------------------------------------------+-------------------------------------------------------------------------+
| :ref:`cfg_Force_HTTP_When_SSL_Not_Required`   | Эта опция нужна для того, чтобы при переходе со страницы с              |
| ("Redirect to HTTP when SSL is not required") | включенным SSL протоколом на страницу без SSL, происходил автоматический|
|                                               | переход на адрес без https.                                             |
+-----------------------------------------------+-------------------------------------------------------------------------+
| :ref:`cfg_UseModRewriteWithSSL`               | Если пользовательская часть сайта использует технологию MOD_REWRITE, то |
| ("Enable MOD_REWRITE for SSL")                | можно (но не обязательно) включить данную опцию, для того, чтобы в      |
|                                               | SSL-режиме тоже строились MOD_REWRITE ссылки.                           |
+-----------------------------------------------+-------------------------------------------------------------------------+

Для перехода в SSL-режим и обратно на шаблонах следует использовать тэг ``m_CheckSSL``. Его рекомендуется ставить
в начале шаблона или после тэга ``m_RequireLogin``, когда таковой используется. Ниже приведён пример использования
данного тега в шаблоне:

.. code:: html

   <inp2:m_CheckSSL mode="required"/>
   <inp2:m_include template="inc/header"/> // внутри шаблона "inc/header" должен быть тэг <inp2:m_CheckSSL/>
   HTML Code
   <inp2:m_include template="inc/footer"/>

Описание параметров тега ``m_CheckSSL``:

+------------------------------+------------------------------------------------------------------------------------------------------------+
| название                     | описание                                                                                                   |
+==============================+============================================================================================================+
| .. config-property::         | Если указать "``required``" в качестве значения данного параметра, то шаблон будет помечен, как требующий  |
|    :name: mode               | наличия SSL-режима для своей корректной работы. Если потом зайти на этот шаблон не из SSL-режима, то будет |
|    :type: string             | автоматически включён SSL-режим. Если параметр не указывать или указать пустое значение, то произойдёт     |
|                              | обратное действие.                                                                                         |
+------------------------------+------------------------------------------------------------------------------------------------------------+
| .. config-property::         | Если указать данный параметр, то SSL-режим будет включаться только для авторизованных пользователей.       |
|    :name: for_logged_in_only |                                                                                                            |
|    :type: int                |                                                                                                            |
|                              |                                                                                                            |
+------------------------------+------------------------------------------------------------------------------------------------------------+
| .. config-property::         | Название :doc:`конфигурационной переменной </system_setup/configuration_variables>`, значение которой      |
|    :name: condition          | нужно проверить перед тем, как разрешать переход в SSL-режим. Если указанная конфигурационная переменная   |
|    :type: string             | отсутствует или выключена, то переход в SSL-режим осуществлён не будет.                                    |
|                              |                                                                                                            |
|                              | .. tip::                                                                                                   |
|                              |                                                                                                            |
|                              |    Для пользовательской части сайта можно использовать конфигурационную переменную                         |
|                              |    :ref:`cfg_Require_SSL`.                                                                                 |
|                              |                                                                                                            |
|                              | Если планируется переключать некоторые части сайта в SSL-режим в зависимости от настроек конфигурации,     |
|                              | то этот параметр является тем, что нужно.                                                                  |
+------------------------------+------------------------------------------------------------------------------------------------------------+

.. figure:: /images/Ssl_front.jpg
   :figwidth: 180px
   :width: 180px
   :align: left
   :alt: Профиль пользователя в режиме SSL

   Профиль пользователя в режиме SSL

Вот в принципе и все, после включения всех соответствующих опций и установки тэга ``m_CheckSSL`` можно считать настройку законченной. На
приведённом слева изображении показана страница ``My Account``, со включенным протоколом SSL. На ней также можно отчётливо видеть 2 корректных "SSL замочка", которые
свидетельствуют о том, что защищённый режим установлен правильно. Если же эти "замочки" показаны с перечёркнутой линией, то это означает, что протокол не корректно установлен на
сервере или время его действия истекло.

.. clear-float::

.. figure:: /images/Secure_warning.jpg
   :figwidth: 180px
   :width: 180px
   :align: left
   :alt: Предупреждение SSL сертификата

   Предупреждение SSL сертификата

Возможна ситуация, когда браузер может, при попадании на страницу, показывать приведённое на изображении слева сообщение об ошибке.
Как правило, такое сообщение можно увидеть тогда, когда на странице есть ссылка, которая прописана не через относительный путь, а
через абсолютный и без указания факта использования протокола SSL. Чтобы этого избежать настоятельно рекомендуется все ссылки на
элементы сайта (изображения, таблицы стилей и т.п.) формировать при помощи тэга ``m_TemplatesBase``:

- **не правильно**: ``<img src="http://www.youdomain.com/img/sample_image.gif" alt=""/>``
- **правильно**: ``<img src="<inp2:m_TemplatesBase/>/img/sample_image.gif" alt=""/>``

.. clear-float::

.. _Data Source: http://guide.in-portal.org/rus/index.php/K4:%D0%9A%D0%B0%D0%BA_%D0%B2%D0%BA%D0%BB%D1%8E%D1%87%D0%B8%D1%82%D1%8C_SSL-%D1%80%D0%B5%D0%B6%D0%B8%D0%BC
.. _Eng Data Source: http://guide.in-portal.org/eng/index.php/K4:Enabling_SSL
.. _Confluence: http://community.in-portal.org/pages/viewpage.action?pageId=14155803
