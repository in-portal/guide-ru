Hooks
=====
`Data Source`_
`Eng Data Source`_

K4 позволяет программисту выполнять требуемую функциональность до или после нужных :doc:`событий </events>`
в системе. Например можно удалять файл картинки с жёсткого диска при удалении записи о картинке из базы
данных. Данная возможность реализована через механизм, называемый "hooks".

Hook - это событие (event), которое будет выполняться до или после того события, с которым он связан по
средством ключа **в массиве Hooks**, находящегося в
:doc:`unit config </components/unit_configs/configuration_files>` файле. Количество hooks на одно и то же
событие не ограничено. Условные обозначения, использованные в данной статье:

- **текущий unit config** - это тот unit config, в котором описывается сам hook
- **главное событие** - событие, которое приводит к вызову hook

Правила хорошего тона
---------------------

- hook должен работать с данными того unit config, в котором он объявлен или с данными главного события
- hook и то, событие, с которым он связан не должны находиться в одном
  :doc:`обработчике событий </components/event_handler/event_handlers>` (т.е. чтобы значение ключей
  HookToPrefix и DoPrefix **не совпадало**)

Доступ к главному событию из тела hook производиться через конструкцию

.. code:: php

   $master_event =& $event->MasterEvent;

Добавление hook
---------------

Hook можно добавить использую приведённый ниже код:

.. code:: php

   'Hooks' => Array (
       Array (
           'Mode' => hAFTER,
           'Conditional' => false,
           'HookToPrefix' => '#PARENT#',
           'HookToSpecial' => '*',
           'HookToEvent' => Array ('OnAfterItemDelete'),
           'DoPrefix' => '',
           'DoSpecial' => '',
           'DoEvent' => 'OnDeleteForeignRelations',
       ),
   ),

Все указанные выше ключи (при объявлении hook) обязательны. Если требуется на время выключить hook, то надо
**закомментировать** его объявление **полностью**, а не только ключ ``DoEvent`` к примеру. Все ключи
начинающиеся с ``HookTo`` относятся к заданию главного события, а ключи, начинающиеся с ``Do`` описывают
какое событие будет вызываться.

+-------------------------+----------------------------------------------------------------------------------------+
| название опции          | описание опции                                                                         |
+=========================+========================================================================================+
| .. config-property::    | Когда будет выполняться hook относительно главного события (к которому он привязан):   |
|    :name: Mode          |                                                                                        |
|    :type: int           | - ``hBEFORE`` - выполняться до основного события (в таких hooks можно отменять вызов   |
|    :ref_prefix: hook_   |   основного события);                                                                  |
|                         | - ``hAFTER`` - выполняться после основного события (будут выполняться только если      |
|                         |   основное события успешно завешилось).                                                |
+-------------------------+----------------------------------------------------------------------------------------+
| .. config-property::    | - ``true`` - выполняться только при наличии, в ``$_REQUEST``, данных от                |
|    :name: Conditional   |   :ref:`префикса <uc_Prefix>` из опции :ref:`hook_DoPrefix`;                           |
|    :type: boolean       | - ``false`` - выполняться всегда                                                       |
|    :ref_prefix: hook_   |                                                                                        |
+-------------------------+----------------------------------------------------------------------------------------+
| .. config-property::    | Префикс, для которого создан hook.                                                     |
|    :name: HookToPrefix  |                                                                                        |
|    :type: string        |                                                                                        |
|    :ref_prefix: hook_   |                                                                                        |
+-------------------------+----------------------------------------------------------------------------------------+
| .. config-property::    | Special при котором будет срабатывать hook.                                            |
|    :name: HookToSpecial |                                                                                        |
|    :type: string        |                                                                                        |
|    :ref_prefix: hook_   |                                                                                        |
+-------------------------+----------------------------------------------------------------------------------------+
| .. config-property::    | Список :doc:`событий </events>` с которыми данный hook будет связан (будет выполняться |
|    :name: HookToEvent   | до или после них).                                                                     |
|    :type: array         |                                                                                        |
|    :ref_prefix: hook_   |                                                                                        |
+-------------------------+----------------------------------------------------------------------------------------+
| .. config-property::    | Префикс того :doc:`unit config </components/unit_configs/configuration_files>`, у      |
|    :name: DoPrefix      | которого будет выполняться hook (т.е. где он определён).                               |
|    :type: string        |                                                                                        |
|    :ref_prefix: hook_   |                                                                                        |
+-------------------------+----------------------------------------------------------------------------------------+
| .. config-property::    | Special, с которым вызывать событие из опции :ref:`hook_DoEvent`.                      |
|    :name: DoSpecial     |                                                                                        |
|    :type: string        |                                                                                        |
|    :ref_prefix: hook_   |                                                                                        |
+-------------------------+----------------------------------------------------------------------------------------+
| .. config-property::    | Событие, которое должно выполняться когда сработает hook.                              |
|    :name: DoEvent       |                                                                                        |
|    :type: string        |                                                                                        |
|    :ref_prefix: hook_   |                                                                                        |
+-------------------------+----------------------------------------------------------------------------------------+

Специальные значения опций
--------------------------

Для более гибкого (flexible) определения hook **рекомендуется** применять следующие специальные значения для
опций при его объявлении:

- ``HookToPrefix = '#PARENT#'`` - использовать значение ключа :ref:`uc_ParentPrefix` текущего unit config;
- ``HookToSpecial = '*'`` - надо вызывать данный hook при любом Special у главного события;
- ``DoPrefix = ''`` - событие из ``DoEvent`` ключа находится в
  :doc:`обработчике событий </components/event_handler/event_handlers>` заданном в текущем unit config;
- ``DoSpecial = '*'`` - использовать тот Special, с которым вызвано главное событие.

.. versionadded:: 5.0.0

- ``HookToPrefix = '*'`` - любой префикс (т.е. выполняться для всех, зарегистрированных в системе префиксов);

.. _Data Source: http://guide.in-portal.org/rus/index.php/K4:Hooks
.. _Eng Data Source: http://guide.in-portal.org/eng/index.php/K4:Hooks
