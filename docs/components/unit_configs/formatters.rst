Formatters
==========
`Data Source`_
`Eng Data Source`_

В K4 существует 2 способа отображения информации:

- для записи в базу данных
- для отображения пользователю

Классическим примером этому может служить ввод даты, т.к. пользователь вводит дату в понятном ему формате
``28/12/2007 22:10:43`` (dd/mm/yyyy hh:mm:ss), а в базе данных эта дата уже находиться в форме timestamp
``1198872643`` (количество секунд, прошедших с 1 января 1969 года). Для автоматического выполнения такого
рода преобразований в K4 существует ряд классов, называемых ``форматеры (formatters)``. Они так называются
потому что они осуществляют форматирование данных. Все форматеры унаследованы от класса ``kFormatter``.
У них есть как минимум 2 доступных метода (может увеличиваться в зависимости от форматера):

- ``Format`` - осуществляет преобразования ``db_value -> form_value`` (прямое преобразование)
- ``Parse`` - осуществляет преобразование ``form_value -> db_value`` (обратное преобразование)

Эти методы автоматически вызываются при использовании методов ``kDBBase::GetField`` (item и list) и
``kDBItem::SetField`` (item). Метод ``kDBBase::GetField`` кроме названия поля (первый параметр) также
принимает и второй (необязательный) параметр ``$format`` с помощью которого можно задать другой формат
вывода (см. опцию ``format`` у конкретного форматера) для текущего вызова этого метода. Этот формат
также можно указывать в параметре format у тэга Field:

.. code:: xml

   <inp2:prefix_Field name="CreatedOn" format="d-m-Y"/>

Форматеры не рекомендуется использовать в ручную.

.. note::

   Поведением форматера **можно управлять** указывая те или иные опции у поля, описанного в массиве
   :ref:`uc_Fields` в unit configs.

.. _fmt_class_kFormatter:

kFormatter
----------

Данный форматер используется на формах где требуется **вводить числа** (т.к. они форматируются согласно
региональным установкам), а так же если требуется **вводить адреса электронной почты**. Этот форматер
является базовым классом для всех форматеров, а так же позволяет использовать оператор строго
равенства (``===``) на итоговое значение поля, т.к. **производит приведение типов**
(`type casting <https://www.php.net/manual/en/language.types.type-juggling.php#language.types.typecasting>`__).
Далее перечислены опции, которые использует этот форматер:

+----------------------+-----------------------------------------------------------------------------------------------------+
| опция                | описание                                                                                            |
+======================+=====================================================================================================+
| .. config-property:: | Тип значения в поле (или тип поля). Используется при обеих преобразованиях                          |
|    :name: type       | значения поля. Например для отображения числа с 2 знаками после запятой                             |
|    :type: string     | (15.66) нужно использовать следующее значение данной опции: ``'%01.2f'``.                           |
|    :ref_prefix: fmt_ |                                                                                                     |
+----------------------+-----------------------------------------------------------------------------------------------------+
| .. config-property:: | Формат отображаемого значения (метод Format). Используется как $format для                          |
|    :name: format     | функции `sprintf <https://www.php.net/sprintf>`__.                                                  |
|    :type: string     |                                                                                                     |
|    :ref_prefix: fmt_ |                                                                                                     |
+----------------------+-----------------------------------------------------------------------------------------------------+
| .. config-property:: | Маска (регулярное выражение), которой должно соответствовать значение в поле                        |
|    :name: regexp     | (метод Parse). Ниже представлены самые распространённые регулярные выражения:                       |
|    :type: string     |                                                                                                     |
|    :ref_prefix: fmt_ | - в поле должен быть адрес электронной почты - ``'/'.REGEX_EMAIL_USER.'@'.REGEX_EMAIL_DOMAIN.'/'``; |
|                      | - в поле не должно быть цифр - ``/^[^\d]+$/``.                                                      |
+----------------------+-----------------------------------------------------------------------------------------------------+
| .. config-property:: | В целях безопасности все данные, приходящие с Front-End преобразуются, используя                    |
|    :name: allow_html | функцию `htmlspecialchars <https://www.php.net/htmlspecialchars>`__. Если для                       |
|    :type: int        | конкретного поля этого делать не требуется (напр. на поле подключён HTML редактор),                 |
|    :ref_prefix: fmt_ | то нужно указать у поля эту опцию.                                                                  |
+----------------------+-----------------------------------------------------------------------------------------------------+
| .. config-property:: | .. versionadded:: 5.0.0                                                                             |
|    :name: using_fck  |                                                                                                     |
|    :type: int        | Если для ввода значения в поле (в административной консоли) используются блоки                      |
|    :ref_prefix: fmt_ | :ref:`form_control_inp_edit_textarea`, :ref:`form_control_inp_edit_textarea_ml`,                    |
|                      | :ref:`form_control_inp_edit_fck` то значение в поле можно вводить используя                         |
|                      | ``FCKEditor``. При работе с ``FCKEditor`` внутренние ссылки (internal links)                        |
|                      | в поле хранятся как ``@@CategoryId@@``. Для того, чтобы при выводе значения                         |
|                      | поля на пользовательской части сайта они заменились на фактические адрес                            |
|                      | внутренних страниц сайта нужно указать эту опцию.                                                   |
+----------------------+-----------------------------------------------------------------------------------------------------+

.. _fmt_class_kOptionsFormatter:

kOptionsFormatter
-----------------

Данный форматер используется на формах, где присутствует **элементы ввода с ограниченным выбором** (напр.
:ref:`dropdown <form_control_inp_edit_options>`, :ref:`radio buttons <form_control_inp_edit_radio>`,
:ref:`checkboxes <form_control_inp_edit_checkboxes>`, :ref:`multiselect <form_control_inp_edit_multioptions>`).
Данный форматер может содержать **статический** (заранее определённый) набор опций, а так же **динамический** набор
опций, формируемый при помощи указанного sql запроса. Далее перечислены опции, которые использует этот форматер:

+------------------------------+-----------------------------------------------------------------------------------------------------------------------+
| опция                        | описание                                                                                                              |
+==============================+=======================================================================================================================+
| .. config-property::         | Набор опций в виде ассоциативного массива. На форме ввода будут отображаться                                          |
|    :name: options            | значения этого массива, а в базу будут писаться его ключи. Например, если                                             |
|    :type: array              | используется массив ``Array (1 => 'Yes', 2 => 'No')``, то в базу будет писаться                                       |
|    :ref_prefix: fmt_         | или ``1`` или ``2``, а пользователь будет видеть ``Yes`` или ``No``                                                   |
|                              | соответственно. Использование нуля (``0``), в качестве ключа опции                                                    |
|                              | **не рекомендуется**, т.к. это может привести к некорректному выбору значения                                         |
|                              | по умолчанию при создании новых записей. **Не надо** добавлять в начало массива                                       |
|                              | пустую опцию. Для появления пустой опции на форме редактирования следует передать                                     |
|                              | значение "1" в параметр ``has_empty`` блоку, использующемуся для отображения                                          |
|                              | ``dropdown``, напр.                                                                                                   |
|                              |                                                                                                                       |
|                              | .. code:: html                                                                                                        |
|                              |                                                                                                                       |
|                              |    <inp2:m_RenderElement name="inp_edit_options"                                                                      |
|                              |        prefix="test-prefix"                                                                                           |
|                              |        field="DropdownField"                                                                                          |
|                              |        title="la_fld_DropdownField"                                                                                   |
|                              |        has_empty="1"                                                                                                  |
|                              |    />                                                                                                                 |
+------------------------------+-----------------------------------------------------------------------------------------------------------------------+
| .. config-property::         | .. versionchanged:: 4.2.2                                                                                             |
|    :name: use_phrases        |                                                                                                                       |
|    :type: boolean            |    Можно не указываь эту опцию при использовании блока ``inp_edit_options`` для того,                                 |
|    :ref_prefix: fmt_         |    чтобы фразы в dropdown переводились.                                                                               |
|                              |                                                                                                                       |
|                              | Данная опция указывает на то, что **значение** каждой опции (**не ключ**) является                                    |
|                              | фразой и перед показыванием пользователю его следует перевести используя метод                                        |
|                              | ``Application::Phrase`` (происходит автоматически).                                                                   |
|                              |                                                                                                                       |
|                              |                                                                                                                       |
+------------------------------+-----------------------------------------------------------------------------------------------------------------------+
| .. config-property::         | SQL запрос, используемый для получения динамического списка опций. Самый распространённый                             |
|    :name: options_sql        | вариант это выборка из другой таблицы без условия, отсортированная по алфавиту. Примером                              |
|    :type: string             | может послужить данный sql запрос:                                                                                    |
|    :ref_prefix: fmt_         |                                                                                                                       |
|                              | .. code:: php                                                                                                         |
|                              |                                                                                                                       |
|                              |    'SELECT %s FROM '.TABLE_PREFIX.'SampleTable ORDER BY SampleName'                                                   |
|                              |                                                                                                                       |
|                              | В данном запросе ``%s`` будет заменено на комбинацию названий полей, использующихся для                               |
|                              | выборки опций.                                                                                                        |
+------------------------------+-----------------------------------------------------------------------------------------------------------------------+
| .. config-property::         | .. versionchanged:: 4.3.0                                                                                             |
|    :name: option_key_field   |                                                                                                                       |
|    :type: string             |    Добавлена возможность использования SQL выражений (напр. ``CONCAT(FieldName, ' sample')``).                        |
|    :ref_prefix: fmt_         |                                                                                                                       |
|                              | Название колонки в sql запросе, из которой брать ключи опций (то, что будет в базе данных).                           |
+------------------------------+-----------------------------------------------------------------------------------------------------------------------+
| .. config-property::         | .. versionchanged:: 4.3.0                                                                                             |
|    :name: option_title_field |                                                                                                                       |
|    :type: string             |    Добавлена возможность использования SQL выражений (напр. ``CONCAT(FieldName, ' sample')``).                        |
|    :ref_prefix: fmt_         |                                                                                                                       |
|                              | Название колонки в SQL запросе, из которой брать значения опций (то, что пользователь увидит).                        |
+------------------------------+-----------------------------------------------------------------------------------------------------------------------+
| .. config-property::         | .. versionadded:: 5.0.0                                                                                               |
|    :name: option_constrain   |                                                                                                                       |
|    :type: string             | Фильтр, который был применён в :ref:`запросе на выбор опций <fmt_options_sql>`                                        |
|    :ref_prefix: fmt_         | (тот, что после слова ``WHERE``). Т.е. если в опции :ref:`fmt_options_sql` был применён                               |
|                              | фильтр, то его необходимо продублировать здесь. Используется для корректной выборки                                   |
|                              | опций в блоке                                                                                                         |
|                              | :doc:`inp_edit_picker </administrative_console_interface/working_with_forms/working_with_editpickerhelper_class>`.    |
+------------------------------+-----------------------------------------------------------------------------------------------------------------------+

Можно комбинировать статические и динамические опции, т.е. задавать полю опцию :ref:`fmt_options`
и :ref:`fmt_options_sql` одновременно. В значениях опций поля, отвечающих за формирование динамических
опций для форматера (:ref:`fmt_options_sql`, :ref:`fmt_option_key_field`, :ref:`fmt_option_title_field`)
можно указывать ключевое слово ``%2$s``, которое замениться на :ref:`ID текущего языка <tc_Language_LanguageId>`.
Обычно это используется когда требуется построить список опций на текущем
:doc:`языке </database/table_structure/language>` из многоязычного поля (т.е. поля, которое использует форматер
:ref:`fmt_class_kMultiLanguage`).

.. _fmt_class_kMultiLanguage:

kMultiLanguage
--------------

Данный форматер используется для обработки многоязычных полей, т.е. полей, значение в которых может
изменяться в зависимости от языка, на котором просматривается сайт. Обычно это элементы (form controls)
со свободным вводом данных (:ref:`textbox <form_control_inp_edit_box_ml>`,
:ref:`textarea <form_control_inp_edit_textarea_ml>`), т.к. у элементов ввода с ограниченным выбором
видимая пользователю часть состоит из переводов фраз. В базе данных для каждого поля, использующего
этот форматер, автоматически создаётся (напр. при добавлении нового языка) по одной колонке на каждый
язык. Название колонки состоит из ID языка и названия поля в формате ``l<LanguageId>_<FieldName>``,
напр. для хранения значения поля TestField в языке с 1-м ID колонка будет называться ``l1_TestField``.
Если требуется добавить новое многоязычное поле в базу данных, то надо:

- добавить его описание в массив :ref:`uc_Fields` в unit config
- воспользоваться функцией "**Re-build Multilanguage Fields**" в секции
  "**Configuration -> Service Tools**" (Platform) или "**Tools -> Service**" (In-Portal).

Далее перечислены опции, которые использует этот форматер:

+----------------------+---------------------------------------------------------------------------------------+
| опция                | описание                                                                              |
+======================+=======================================================================================+
| .. config-property:: | Поддерживается только одно значение данной опции: ``no_default``. Если его указать,   |
|    :name: format     | то значение из поля на основном (primary) языке не будет использоваться как значение  |
|    :type: string     | поля для остальных языков, когда в них не будет своего значения.                      |
|    :ref_prefix: fmt_ |                                                                                       |
+----------------------+---------------------------------------------------------------------------------------+
| .. config-property:: | Тип и размер значения поля в базе данных (напр. ``varchar(255)``, ``text``,           |
|    :name: db_type    | ``int(11)``). Используется при создании новый переводимых полей в базе данных.        |
|    :type: string     |                                                                                       |
|    :ref_prefix: fmt_ |                                                                                       |
+----------------------+---------------------------------------------------------------------------------------+
| .. config-property:: | .. versionadded:: 5.0.0                                                               |
|    :name: using_fck  |                                                                                       |
|    :type: int        | Если для ввода значения в поле (в административной консоли) используются блоки        |
|    :ref_prefix: fmt_ | :ref:`form_control_inp_edit_textarea`, :ref:`form_control_inp_edit_textarea_ml`,      |
|                      | :ref:`form_control_inp_edit_fck` то значение в поле можно вводить используя           |
|                      | ``FCKEditor``. При работе с ``FCKEditor`` внутренние ссылки (``internal links``)      |
|                      | в поле хранятся как ``@@CategoryId@@``. Для того, чтобы при выводе значения поля      |
|                      | на пользовательской части сайта они заменились на фактические адрес внутренних        |
|                      | страниц сайта нужно указать эту опцию.                                                |
+----------------------+---------------------------------------------------------------------------------------+

Будьте внимательны, т.к. этот форматер **добавляет префикс языка** (напр. ``l5_``) **только при чтении** значения
из поля (т.е. в методе Format). А **при записи** значения в поле (метод Parse) его нужно **добавлять в ручную**.
Это можно наглядно увидеть из следующих примеров:

============================ ============= ==============================
вход (метод и поле)          название поля выход (метод и поле)
============================ ============= ==============================
``GetField('FieldName')``    меняется      ``GetDBField('l5_FieldName')``
``GetField('l5_FieldName')`` не меняется   ``GetDBField('l5_FieldName')``
``SetField('FieldName')``    не меняется   ``SetDBField('FieldName')``
``SetField('l5_FieldName')`` не меняется   ``SetDBField('l5_FieldName')``
============================ ============= ==============================

Форматер изменяет название поля (т.е. добавляет к нему префикс языка) только одном случае, когда
**префикс языка не указан** и **читается значение из поля**. Во всех остальных случаях название
указанного поля и название поля, которое читается из базы данных совпадают.

.. _fmt_class_kDateFormatter:

kDateFormatter
--------------

Данный форматер используется для работы с датой и временем. Он используется на формах, где присутствует
элементы ввода :ref:`даты <form_control_inp_edit_date>`, :ref:`времени <form_control_inp_edit_time>`,
:ref:`даты и времени в одном поле <form_control_inp_edit_date_time>`. Дата и время на формах вводятся в
понятной для человека форме, а в базе хранятся в форме timestamp. Формат даты и времени берётся из
региональных настроек системы (Configuration -> Regional). Форматы, используемые данным форматером
делятся на 2 группы:

- input formats - используются **для ввода** данных из форм;
- output formats - используются **для отображения** данных.

Такое разделение форматов обосновано ограничениями в работе форматера. Для анализа, введённой
пользователем, даты и времени этот форматер использует регулярные выражения, в основе которых
используются численно-буквенные последовательности **фиксированной длинны**. Это в некоторой мере
ограничивает его возможности (напр. буква "F" из `формата дат <https://www.php.net/date>`__ в php),
поэтому для его корректной работы требуется ограничить набор доступных форматов ввода дат. В то же
время на отображение дат это ограничение не накладывается. От этого и такое разделение. Далее
перечислены опции, которые использует этот форматер:

+-------------------------------+------------------------------------------------------------------------------------------+
| опция                         | описание                                                                                 |
+===============================+==========================================================================================+
| .. config-property::          | Формат, используемый для отображения даты и времени в одном поле (напр. в grid).         |
|    :name: format              | Т.к. в региональных настройках форматы даты и времени вводятся отдельно, то для          |
|    :type: string              | их объединения в единый формат используется значение опции ``date_time_separator``       |
|    :ref_prefix: fmt_          | (по умолчанию это пробел).                                                               |
+-------------------------------+------------------------------------------------------------------------------------------+
| .. config-property::          | Формат, используемый для отображения даты (без времени). Если не задан, то берётся       |
|    :name: date_format         | из поля ``DateFormat`` у объекта текущего языка. Если указать пустое значение, то        |
|    :type: string              | в grid будет **показываться** только **время без даты** (т.к. обычно оно показывается    |
|    :ref_prefix: fmt_          | вместе с датой).                                                                         |
+-------------------------------+------------------------------------------------------------------------------------------+
| .. config-property::          | Формат, используемый для отображения времени (без даты). Если не задан, то берётся       |
|    :name: time_format         | из поля ``TimeFormat`` у объекта текущего языка. Если указать пустое значение, то        |
|    :type: string              | в grid будет **показываться** только **дата без времени** (т.к. обычно она               |
|    :ref_prefix: fmt_          | показывается вместе со временем).                                                        |
+-------------------------------+------------------------------------------------------------------------------------------+
| .. config-property::          | Формат, используемый для ввода даты и времени в одном поле (напр. в grid). Т.к. в        |
|    :name: input_format        | региональных настройках форматы даты и времени вводятся отдельно, то для их              |
|    :type: string              | объединения в единый формат используется значение опции :ref:`fmt_date_time_separator`   |
|    :ref_prefix: fmt_          | (по умолчанию это пробел).                                                               |
+-------------------------------+------------------------------------------------------------------------------------------+
| .. config-property::          | Формат, используемый для ввода даты (без времени). Если не задан, то берётся из          |
|    :name: input_date_format   | поля ``InputDateFormat`` у объекта текущего языка. Если указать пустое значение, то      |
|    :type: string              | можно будет **вводить время без даты** (т.к. обычно оно вводиться вместе с датой).       |
|    :ref_prefix: fmt_          |                                                                                          |
+-------------------------------+------------------------------------------------------------------------------------------+
| .. config-property::          | Формат, используемый для ввода времени (без даты). Если не задан, то берётся из поля     |
|    :name: input_time_format   | ``InputTimeFormat`` у объекта текущего языка. Если указать пустое значение, то можно     |
|    :type: string              | будет **вводить дату без времени** (т.к. обычно она вводится вместе со временем).        |
|    :ref_prefix: fmt_          |                                                                                          |
+-------------------------------+------------------------------------------------------------------------------------------+
| .. config-property::          | Символ, при помощи которого форматы даты и времени объединяются в единый формат.         |
|    :name: date_time_separator | Используется в опциях ``format`` и ``input_format``.                                     |
|    :type: string              |                                                                                          |
|    :ref_prefix: fmt_          |                                                                                          |
+-------------------------------+------------------------------------------------------------------------------------------+
| .. config-property::          | Значение времени (в форме timestamp), которое будет использовано для формирования        |
|    :name: empty_time          | полноценного значения (дата и время) поля в базе данных в случае, когда время не         |
|    :type: string              | будет задано (напр. из формы). По умолчанию используется утро (00:00:00) от текущей      |
|    :ref_prefix: fmt_          | даты.                                                                                    |
+-------------------------------+------------------------------------------------------------------------------------------+
| .. config-property::          | Указывает на то, что надо делать поправку на смещение по часовому поясу (time zone),     |
|    :name: use_timezone        | используемое в операционной системе сервера при отображении даты и времени (по           |
|    :type: boolean             | умолчанию "*true*"). В некоторых случаях добавляемое смещение (может быть отрицательным) |
|    :ref_prefix: fmt_          | может мешать. Когда заведомо известно, что показываемая **дата с календарём** никак      |
|                               | **не связана**, а напр. является просто временным интервалом (абстрактное количество     |
|                               | секунд без даты вообще), то лучше указать "*false*" в качестве значения данной опции.    |
+-------------------------------+------------------------------------------------------------------------------------------+

В качестве значения любой из выше описанных опций задающих формат можно указать значение в форме
``_regional_FieldName``, где FieldName является названием поля из текущего объекта языка. В этом
случае формат будет взят из указанного поля у объекта текущего языка.

Кроме преобразований значения поля этот форматер добавляет новое вычисляемое поле (calculated field),
в котором будет отформатированное, по опции format (превращённого в аналогичный формат в SQL), значение
поля. Это поле будет называться ``<Field>_formatted`` (где Field будет соответствовать названию поля с
датой). Оно используется в In-Portal для поиска по полям, использующих этот форматер (если его не
использовать, то поиск будет идти по значению timestamp). Для Platform эта проблема не актуальна, т.к.
в grids над каждой колонкой используется индивидуальный фильтр с собственным форматом.

Так же этот форматер создаёт по 2 :ref:`виртуальных поля <uc_VirtualFields>` и
2 :ref:`вычисляемых поля <uc_CalculatedFields>` (для редактируемых grids) на каждое поле, на которое он
наложен. Они используются для отдельного хранения даты и времени (т.к. на формах редактирования тоже
2 поля):

- ``<FieldName>_date`` - для даты (напр. ``CreatedOn_date``);
- ``<FieldName>_time`` - для времени (напр. ``CreatedOn_time``).

Если требуется установить значение в поле, то надо пользоваться именно этими двумя полями:

.. code:: php

   $timestamp = adodb_mktime(); // то, что мы ставим (оригинальное поле с датой: DateField)
   $object->SetDBField('DateField_date', $timestamp);
   $object->SetDBField('DateField_time', $timestamp);

.. note::

   Если ставить значение в поле на прямую (не использую данные виртуальные поля), то тогда это
   значение будет переписано значениями из соответствующих виртуальных полей.

.. _fmt_class_kUploadFormatter:

kUploadFormatter
----------------

Это форматер используется для загрузки файлов на сервер. Существует 2 способа загрузки файлов на сервер,
которые понимает этот форматер:

.. figure:: /images/Swf_upload_control.gif
   :alt: Flash upload control
   :align: left

   Flash upload control

загрузка :ref:`с индикатором прогресса загрузки <form_control_inp_edit_swf_upload>` файла
(поддерживается только начиная с `Flash <http://www.adobe.com/products/flash/?ogn=EN_US-gntray_prod_flash_home>`__
7 версии);

.. clear-float::

.. figure:: /images/Html_upload_control.gif
   :alt: HTML input upload control
   :align: left

   HTML input upload control

загрузка :ref:`без индикации процесса загрузки <form_control_inp_edit_upload>`,
используя HTML тэг ``<input type="file"/>`` (поддерживается везде).

.. clear-float::

У каждого из них есть свои плюсы и минусы, но исторически сложилось, что в Platform используется индикатор
загрузки файла, а в In-Portal нет. Далее перечислены опции, которые использует этот форматер.

Общие опции
^^^^^^^^^^^

+----------------------+------------------------------------------------------------------------------------------+
| опция                | описание                                                                                 |
+======================+==========================================================================================+
| .. config-property:: | Данная опция допускает следующие значения:                                               |
|    :name: format     |                                                                                          |
|    :type: string     | - ``full_url`` - вернуть ссылку для сохранения файла (для браузера)                      |
|    :ref_prefix: fmt_ | - ``full_path`` - вернуть полный путь к файлу на сервере (в файловой системе             |
|                      |   сервера)                                                                               |
|                      | - ``file_size`` - вернуть размер файла в байтах                                          |
|                      | - ``resize:WxH`` - вернуть масштабированную к указанному размеру картинку                |
|                      |   (W - ширина, H - высота)                                                               |
|                      | - ``wm:WM_FILENAME|H_MARGIN|V_MARGIN`` - наложить указанный водяной знак (watermark)     |
|                      |   на запрашиваемое изображение:                                                          |
|                      |                                                                                          |
|                      |   - ``WM_FILENAME`` - файл, содержащий водяной знак (путь относительно директории с      |
|                      |     темой на Front-End);                                                                 |
|                      |   - ``H_MARGIN`` - смещение водяного знака на основном изображении по горизонтали:       |
|                      |                                                                                          |
|                      |     - C - по центру изображения;                                                         |
|                      |     - положительное значение - отступ от левой границы изображения;                      |
|                      |     - отрицательное значение - отступ от правой границы изображения;                     |
|                      |                                                                                          |
|                      |   - ``V_MARGIN`` - смещение водяного знака на основном изображении по вертикали:         |
|                      |                                                                                          |
|                      |     - C - по центру изображения;                                                         |
|                      |     - положительное значение - отступ от верхней границы изображения;                    |
|                      |     - отрицательное значение - отступ от нижней границы изображения.                     |
|                      |                                                                                          |
|                      | Значения ``resize`` и ``wm`` можно комбинировать используя точку с запятой, напр.        |
|                      | ``'resize:150x150;wm:platform/img/wm.png|-5|-5'``.                                       |
|                      |                                                                                          |
|                      | .. note::                                                                                |
|                      |                                                                                          |
|                      |   Если применяется формат ``resize`` или ``files_resized`` то предварительно необходимо  |
|                      |   **создать директорию "resized"** в директории, где хранятся исходные изображения.      |
|                      |                                                                                          |
|                      | .. versionadded:: 5.0.0                                                                  |
|                      |                                                                                          |
|                      | - ``img_size`` - вернуть размеры изображения для ``img`` HTML-тэга в виде:               |
|                      |   width="M" height="N";                                                                  |
|                      |                                                                                          |
|                      | В случае, когда требуется обработать поле, в котором находятся несколько файлов надо     |
|                      | использовать значения:                                                                   |
|                      |                                                                                          |
|                      | - ``file_urls`` - аналог ``full_url``;                                                   |
|                      | - ``file_sizes`` - аналог ``file_size``;                                                 |
|                      |                                                                                          |
|                      | .. versionadded:: 4.2.1                                                                  |
|                      |                                                                                          |
|                      | - ``wms`` - аналог ``wm``;                                                               |
|                      | - ``files_resized`` - аналог ``resize``;                                                 |
|                      |                                                                                          |
|                      | .. versionadded:: 4.3.1                                                                  |
|                      |                                                                                          |
|                      | - ``file_paths`` - аналог ``full_path``;                                                 |
|                      |                                                                                          |
|                      | .. versionadded:: 5.0.0                                                                  |
|                      |                                                                                          |
|                      | - ``img_sizes`` - аналог ``img_size``.                                                   |
|                      |                                                                                          |
|                      |                                                                                          |
|                      | Например для получения масштабированной версии изображения, хранящегося в поле требуется |
|                      | написать следующее:                                                                      |
|                      |                                                                                          |
|                      | .. code::                                                                                |
|                      |                                                                                          |
|                      |    <img                                                                                  |
|                      |        src="<inp2:Field name='$field' format='resize:120x120'/>"                         |
|                      |        <inp2:Field name='$field' format='resize:120x120;img_size' no_special='1'/>       |
|                      |        alt=""                                                                            |
|                      |    />                                                                                    |
|                      |                                                                                          |
|                      | Если не использовать параметр `no_special <TagProcessor:Field#no_special>`__ тэга        |
|                      | `Field <TagProcessor:Field>`__, то кавычки вокруг размеров изображения заменятся на      |
|                      | ``&quot;`` символы. Также можно указывать формат ``img_size/img_sizes`` без формата      |
|                      | ``resize/files_resized``.                                                                |
+----------------------+------------------------------------------------------------------------------------------+
| .. config-property:: | Директория, куда нужно сохранять закачанный файл. Задаётся относительно значения         |
|    :name: upload_dir | :ref:`const_FULL_PATH` константы, напр. ``/system/user_files/manufactures/``.            |
|    :type: string     | Если некоторые составляющие пути можно заменить значением констант, то это конечно       |
|    :ref_prefix: fmt_ | нужно сделать. Например в Platform есть константа :ref:`const_WRITEBALE_BASE` со         |
|                      | значением ``/system``, которую можно здесь использовать. Обычно относительный путь       |
|                      | для сохранения закачанных файлов (т.е. значение данной опции) определяют в файле         |
|                      | :doc:`constants.php </application_structure/constants>` у модуля "Custom" для            |
|                      | последующего использования в дальнейшем.                                                 |
+----------------------+------------------------------------------------------------------------------------------+
| .. config-property:: | Максимальный размер одного загружаемого файла в байтах. Если не задан, то будет          |
|    :name: max_size   | использоваться значение константы :ref:`const_MAX_UPLOAD_SIZE`.                          |
|    :type: int        |                                                                                          |
|    :ref_prefix: fmt_ |                                                                                          |
+----------------------+------------------------------------------------------------------------------------------+

Опции только для загрузчика без индикатора
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

+------------------------------+-------------------------------------------------------------------------------------------+
| опция                        | описание                                                                                  |
+==============================+===========================================================================================+
| .. config-property::         | Название поля, в которое записать размер загруженного файла.                              |
|    :name: size_field         |                                                                                           |
|    :type: string             |                                                                                           |
|    :ref_prefix: fmt_         |                                                                                           |
+------------------------------+-------------------------------------------------------------------------------------------+
| .. config-property::         | Название поля, в которое записать имя загруженного файла в системе                        |
|    :name: orig_name_field    | пользователя (т.е. как он назывался на компьютере того, кто его                           |
|    :type: string             | загружал).                                                                                |
|    :ref_prefix: fmt_         |                                                                                           |
+------------------------------+-------------------------------------------------------------------------------------------+
| .. config-property::         | Название поля, в которое записать mime-тип загруженного файла,                            |
|    :name: content_type_field | посланный браузером.                                                                      |
|    :type: string             |                                                                                           |
|    :ref_prefix: fmt_         |                                                                                           |
+------------------------------+-------------------------------------------------------------------------------------------+
| .. config-property::         | Mime-типы файлов, которые можно загружать. Если не указать ничего, то можно               |
|    :name: allowed_types      | загружать любые файлы. Это наименее надёжный способ определения типа загруженного         |
|    :type: array              | файла, т.к. он ориентируется на тот mime-тип, который браузер посылает на сервер          |
|    :ref_prefix: fmt_         | (который можно легко сфабриковать). Например если браузер не знает (по расширению         |
|                              | или заголовку файла) какой у него mime-тип, то он скорее всего пошлёт                     |
|                              | ``text/plain``, а это совсем не то, что надо. Идеальным вариантом является анализ         |
|                              | уже загруженного файла используя функцию `finfo_file <https://www.php.net/finfo-file>`__  |
|                              | для определения фактического mime-типа. Возможно после перехода на php5 так и сделаем     |
|                              | (т.к. эта функция есть только в php5).                                                    |
+------------------------------+-------------------------------------------------------------------------------------------+

Опции только для загрузчика с индикатором
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

Задание всех из ниже описанных параметров, кроме :ref:`fmt_multiple`, является обязательным для успешной работы
загрузчика.

.. warning::

   Если не задать хотя-бы один из ниже перечисленных параметров, кнопки ``browse`` и ``upload`` работать не будут!

+-----------------------------+---------------------------------------------------------------------------------------+
| опция                       | описание                                                                              |
+=============================+=======================================================================================+
| .. config-property::        | Максимальное количество файлов, которое можно загрузить в поле. Если загружено        |
|    :name: multiple          | больше одного файла, то, в значении поля, имена файлов будут разделены символом       |
|    :type: int               | вертикальной черты (``|``).                                                           |
|    :ref_prefix: fmt_        |                                                                                       |
+-----------------------------+---------------------------------------------------------------------------------------+
| .. config-property::        | Строить прямые ссылки на сохранение загруженных файлов в swf upload control.          |
|    :name: direct_links      |                                                                                       |
|    :type: boolean           |                                                                                       |
|    :ref_prefix: fmt_        |                                                                                       |
+-----------------------------+---------------------------------------------------------------------------------------+
| .. config-property::        | Маска для имён файлов, которые можно загружать на сервер. Например:                   |
|    :name: file_types        | ``'*.jpg;*.gif;*.png'``.                                                              |
|    :type: string            |                                                                                       |
|    :ref_prefix: fmt_        |                                                                                       |
+-----------------------------+---------------------------------------------------------------------------------------+
| .. config-property::        | Описание к указанной маске файлов, напр. ``'!la_title_ImageFiles!'``. Значение        |
|    :name: files_description | данной опции не запрещает наличие и фраз и простого текста одновременно. Для того,    |
|    :type: string            | чтобы текст был рассмотрен, как фраза его надо экранировать одинарными кавычками. Вот |
|    :ref_prefix: fmt_        | более сложный пример: ``'sample text !la_phrase! other text'``. В данном примере      |
|                             | фразой будет текст la_phrase, а остальной текст останется без изменений.              |
|                             |                                                                                       |
|                             | .. warning::                                                                          |
|                             |                                                                                       |
|                             |    К сожалению на данный момент времени фразы, из значения данного параметра не       |
|                             |    переводятся (см. заявку).                                                          |
+-----------------------------+---------------------------------------------------------------------------------------+

.. note::

   При использовании загрузчика с индикатором файл после закачки (нажатия кнопки ``Upload``) попадает в
   директорию ``/system/tmp`` и **только если** объект, содержащий поле для загрузки будет сохранён в
   базу данных (напр. события :doc:`/events/live_editing/on_create`, :doc:`/events/live_editing/on_update`,
   :doc:`/events/onpresave/on_pre_save`, :doc:`/events/temp_editing/on_save` и т.п.) файл будет перемещён
   в директорию, указанную в опции :ref:`fmt_upload_dir` у используемого поля.

Результат загрузки файлов на сервер может быть удачным, а может и не быть. В таком случае будет показана ошибка.
Самая распространённая ошибка о том, что нету права сохранять файлы в директорию заданную в опции
:ref:`fmt_upload_dir` или директорию ``/system/tmp``. Так же бывают ошибки о том, что файл нельзя загрузить, т.к.

- его размер больше требуемого;
- его mime-тип не соответствует заданному.

Если файл не загружается по неизвестной причине, то надо проверить наличие атрибута ``enctype`` у HTML
тэга ``form``. Подробнее об этом `здесь <https://www.php.net/features.file-upload>`__.

.. _Data Source: http://guide.in-portal.org/rus/index.php/K4:Formatters
.. _Eng Data Source: http://guide.in-portal.org/eng/index.php/K4:Formatters
