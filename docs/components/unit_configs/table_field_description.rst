Описание полей таблицы
======================
`Data Source`_
`Eng Data Source`_

Обычно каждый unit config создаётся для взаимодействия с **одной** таблицей в базе данных. Для этого
в нём необходимо объявить каждое поле из связанной таблицы в базе данных. Для этого существует опция
:ref:`uc_Fields`. Эта опция является ассоциативным массивом (почти все опции в unit config это
ассоциативные массивы) , в котором ключи это названия полей в таблице, а значения это опции этих полей.
Это массив может быть например таким:

.. code:: php

   'Fields' => Array (
       'ProductId' => Array('type' => 'int', 'not_null' => 1, 'default' => 0),
       'Name' => Array ('type' => 'string', 'formatter' => 'kMultiLanguage', 'required' => 1, 'max_len' => 255, 'default' => ''),
       'Description' => Array ('type' => 'string', 'formatter' => 'kMultiLanguage', 'default' => NULL),
   ),

Из приведённого примера несложно заметить, что ``ProductId``, ``Name`` и ``Description`` это поля,
а содержание остальных массивов это набор опций этих полей. Опции поля делятся на 3 группы:

- **обязательные** - должны всегда присутствовать;
- **проверки соответствия** (validation) - используются при проверки соответствия значения в поле
  с наложенными ограничениями на значение в поле;
- **форматера** - используются указанным |formatters_link|.

Обязательные опции
------------------

+----------------------+---------------------------------------------------------------------------------------+
| название опции       | описание опции                                                                        |
+======================+=======================================================================================+
| .. config-property:: | Указывает тип значения, которое будет храниться в поле. Для всех численных типов      |
|    :name: type       | автоматически проверяется, что значение в поле является числом. Если в таком поле     |
|    :type: string     | будет не число, а например, строка, то на этапе проверки соответствия (validation)    |
|    :ref_prefix: tfd_ | в этом поле будет ошибка. Доступны следующие значения этой опции:                     |
|                      |                                                                                       |
|                      | - **int** - целое число (напр. 543);                                                  |
|                      | - **float** - число с плавающей точностью (напр. 14.66);                              |
|                      | - **string** - строка (напр. 'проверка').                                             |
|                      |                                                                                       |
|                      | **Устаревшие типы (не использовать):**                                                |
|                      |                                                                                       |
|                      | - **integer** - синоним *int*;                                                        |
|                      | - **double** - синоним *float*;                                                       |
|                      | - **real** - синоним *float*;                                                         |
|                      | - **numeric** - синоним *float*.                                                      |
+----------------------+---------------------------------------------------------------------------------------+
| .. config-property:: | Значение по умолчанию в этом поле. **Должно совпадать** со значением по умолчанию     |
|    :name: default    | у этого поля в базе данных. Если физически не возможно (ограничения в базе данных)    |
|    :type: mixed      | синхронизировать значение по умолчанию в базе данных и в опциях поля, то этого делать |
|    :ref_prefix: tfd_ | не надо. Например, при использовании :ref:`fmt_class_kDateFormatter` можно ставить    |
|                      | ``'#NOW#'`` в качестве значения по умолчанию, но поле с датой числовое (т.к. в нём    |
|                      | находиться timestamp) и такое значение в базу данных не записать.                     |
+----------------------+---------------------------------------------------------------------------------------+

Необязательные опции
--------------------

+----------------------+-------------------------------------------------------------------------+
| название опции       | описание опции                                                          |
+======================+=========================================================================+
| .. config-property:: | Если поле в базе данных настроено, как ``NOT NULL``, то надо указывать  |
|    :name: not_null   | данную опцию.                                                           |
|    :type: int        |                                                                         |
|    :ref_prefix: tfd_ |                                                                         |
+----------------------+-------------------------------------------------------------------------+
| .. config-property:: | Название агрегатной функции базы данных (напр. ``AVG``, ``SUM``,        |
|    :name: totals     | ``COUNT`` и т. п.), которая будет использоваться для подсчёта ``total`` |
|    :type: string     | значения по колонке, в которой будет выводиться это поле.               |
|    :ref_prefix: tfd_ |                                                                         |
+----------------------+-------------------------------------------------------------------------+

Опции проверки соответствия
---------------------------

+------------------------------+-------------------------------------------------------------------------------+
| название опции               | описание опции                                                                |
+==============================+===============================================================================+
| .. config-property::         | Название поля, в которое должны писаться ошибки проверок **вместо** этого     |
|    :name: error_field        | поля. Бывает полезно, когда ошибки от нескольких                              |
|    :type: string             | :ref:`виртуальных полей <uc_VirtualFields>` должны показываться у одного      |
|    :ref_prefix: tfd_         | :ref:`реально поля <uc_Fields>`.                                              |
+------------------------------+-------------------------------------------------------------------------------+
| .. config-property::         | См. :ref:`table_field_definition_error_messages`.                             |
|    :name: error_msgs         |                                                                               |
|    :type: array              |                                                                               |
|    :ref_prefix: tfd_         |                                                                               |
+------------------------------+-------------------------------------------------------------------------------+
| .. config-property::         | Максимальное значение (**включая** это значение), которое может быть в        |
|    :name: max_value_inc      | этом поле. Только для числовых полей.                                         |
|    :type: int, float         |                                                                               |
|    :ref_prefix: tfd_         |                                                                               |
+------------------------------+-------------------------------------------------------------------------------+
| .. config-property::         | Минимальное значение (**включая** это значение), которое может быть в         |
|    :name: min_value_inc      | этом поле. Только для числовых полей.                                         |
|    :type: int, float         |                                                                               |
|    :ref_prefix: tfd_         |                                                                               |
+------------------------------+-------------------------------------------------------------------------------+
| .. config-property::         | Максимальное значение (**не включая** это значение), которое может быть       |
|    :name: max_value_exc      | в этом поле. Только для числовых полей.                                       |
|    :type: int, float         |                                                                               |
|    :ref_prefix: tfd_         |                                                                               |
+------------------------------+-------------------------------------------------------------------------------+
| .. config-property::         | Минимальное значение (**не включая** это значение), которое может быть        |
|    :name: min_value_exc      | в этом поле. Только для числовых полей.                                       |
|    :type: int, float         |                                                                               |
|    :ref_prefix: tfd_         |                                                                               |
+------------------------------+-------------------------------------------------------------------------------+
| .. config-property::         | Максимальная длинна строки, которая может быть в этом поле. Только для        |
|    :name: max_len            | строковых полей.                                                              |
|    :type: int                |                                                                               |
|    :ref_prefix: tfd_         |                                                                               |
+------------------------------+-------------------------------------------------------------------------------+
| .. config-property::         | Минимальная длинна строки, которая может быть в этом поле. Только для         |
|    :name: min_len            | строковых полей.                                                              |
|    :type: int                |                                                                               |
|    :ref_prefix: tfd_         |                                                                               |
+------------------------------+-------------------------------------------------------------------------------+
| .. config-property::         | Осуществлять проверку на уникальность значения поля в таблице. Если надо      |
|    :name: unique             | проверить уникальность в сочетании со значениями из других полей, то их       |
|    :type: array              | надо перечислить в виде массива. Если этого делать не надо (т.е. проверяем    |
|    :ref_prefix: tfd_         | это поле само по себе), то надо указать пустой массив. **Не надо**            |
|                              | перечислять в массиве поле, у которого указанна данная опция.                 |
+------------------------------+-------------------------------------------------------------------------------+
| .. config-property::         | Проверять :ref:`уникальность <tfd_unique>` значения в поле только из          |
|    :name: current_table_only | текущей таблицы (live или временной). По умолчанию проверяется из live        |
|    :type: boolean            | таблицы и из временной (если доступна).                                       |
|    :ref_prefix: tfd_         |                                                                               |
+------------------------------+-------------------------------------------------------------------------------+
| .. config-property::         | Поле обязательно к заполнению. Если значение не указано, то в поле будет      |
|    :name: required           | ошибка. Несмотря на ошибочное мнение **ноль**, в качестве значения поля       |
|    :type: int, boolean       | не вызывает ошибку о том, что в поле не указано значение. Но если 0,          |
|    :ref_prefix: tfd_         | указанный в качестве значения, должен вызывать ошибку можно дополнительно     |
|                              | указать опции ограничения интервала значения, напр. ``'min_value_exc' => 0``. |
+------------------------------+-------------------------------------------------------------------------------+

Все выше описанные опции можно объединить в группы по смыслу:

- **интервалы** (``max_value_inc``, ``min_value_inc``, ``max_value_exc``, ``min_value_exc``) - опции,
  использующиеся для проверки принадлежности значения поля указанному интервалу (range);
- **длинна** (``max_len``, ``min_len``) - опции, использующиеся для проверки длинны строки (length).

.. note::

   Если та, или иная опция не нужна, то можно просто убрать её определение из массива опций поля.
   В таком случае не надо будет ставить её значение в ``0`` или ``false``.

.. _table_field_definition_error_messages:

Сообщения об ошибках
--------------------

У каждого поля можно указать альтернативные тексты для всех ошибок используя опцию "**error_msgs**". Ниже приведена
таблица, в которой описаны все стандартные ошибки:

+---------------------------+-----------------------------------------------------+------------------------------------+-------------------------------------------------+
| pseudo                    | описание                                            | значение по умолчанию              | управляется опциями                             |
+===========================+=====================================================+====================================+=================================================+
| ``required``              | Значение в поле не заполнено.                       | ``!la_err_required!``              | :ref:`tfd_required`                             |
+---------------------------+-----------------------------------------------------+------------------------------------+-------------------------------------------------+
| ``unique``                | Значение в поле не уникально.                       | ``!la_err_unique!``                | :ref:`tfd_unique`                               |
+---------------------------+-----------------------------------------------------+------------------------------------+-------------------------------------------------+
| ``value_out_of_range``    | Значение в поле не находиться в разрешённом         | ``!la_err_value_out_of_range!``    | :ref:`tfd_max_value_inc`,                       |
|                           | интервале значений                                  |                                    | :ref:`tfd_min_value_inc`,                       |
|                           |                                                     |                                    | :ref:`tfd_max_value_exc`,                       |
|                           |                                                     |                                    | :ref:`tfd_min_value_exc`                        |
+---------------------------+-----------------------------------------------------+------------------------------------+-------------------------------------------------+
| ``length_out_of_range``   | Длинна строки превышена.                            | ``!la_err_length_out_of_range!``   | :ref:`tfd_max_len`, :ref:`tfd_min_len`          |
+---------------------------+-----------------------------------------------------+------------------------------------+-------------------------------------------------+
| ``bad_type``              | Тип значения в поле не соответствует описанию поля  | ``!la_err_bad_type!``              | :ref:`tfd_type`                                 |
|                           | (напр. ввели букву вместо числа).                   |                                    |                                                 |
+---------------------------+-----------------------------------------------------+------------------------------------+-------------------------------------------------+
| ``invalid_format``        | Формат строки не соответствует требуемому.          | ``!la_err_invalid_format!``        | :ref:`fmt_regexp`                               |
+---------------------------+-----------------------------------------------------+------------------------------------+-------------------------------------------------+
| ``bad_date_format``       | Формат введённой даты не соответствует требуемому.  | ``!la_err_bad_date_format!``       | :ref:`опции                                     |
|                           |                                                     |                                    | kDateFormatter <fmt_class_kDateFormatter>`      |
+---------------------------+-----------------------------------------------------+------------------------------------+-------------------------------------------------+
| ``primary_lang_required`` | Значение в поле на первичном (primary) языке не     | ``!la_err_primary_lang_required!`` | :ref:`tfd_required` (:ref:`опции                |
|                           | заполнено.                                          |                                    | kMultiLanguage <fmt_class_kMultiLanguage>`)     |
+---------------------------+-----------------------------------------------------+------------------------------------+-------------------------------------------------+
| ``bad_file_format``       | Попытка загрузить файл, у которого миме-тип         | ``!la_error_InvalidFileFormat!``   | :ref:`fmt_allowed_types`,                       |
|                           | (``mime-type``) не находиться в списке разрешённых. |                                    | (:ref:`опции                                    |
|                           |                                                     |                                    | kUploadFormatter <fmt_class_kUploadFormatter>`) |
+---------------------------+-----------------------------------------------------+------------------------------------+-------------------------------------------------+
| ``bad_file_size``         | Попытка загрузить файла, размер которого превышает  | ``!la_error_FileTooLarge!``        | :ref:`fmt_max_size` (:ref:`опции                |
|                           | разрешённый.                                        |                                    | kUploadFormatter <fmt_class_kUploadFormatter>`) |
+---------------------------+-----------------------------------------------------+------------------------------------+-------------------------------------------------+
| ``cant_save_file``        | Загруженный на сервер файл не удалось сохранить в   | ``!la_error_cant_save_file!``      | :ref:`fmt_upload_dir` (:ref:`опции              |
|                           | требуемую директорию.                               |                                    | kUploadFormatter <fmt_class_kUploadFormatter>`) |
+---------------------------+-----------------------------------------------------+------------------------------------+-------------------------------------------------+

Эта опция задаётся в виде ассоциативного одномерного массива, в ключах которого указаны ``pseudo`` ошибок
(см. приведённую выше таблицу), а в значениях соответствующие им тексты ошибок:

.. code:: php

   'error_msgs' => Array (
       'required' => '!la_error_CustomRequiredError!'
   )

Если требуется чтобы перевод фразы стал текстом сообщения об ошибке, то нужно заключить её название в
восклицательные знаки:

- ``!la_error_ErrorPhrase!`` - фраза (её перевод на текущем языке это текст ошибка);
- ``Error Message`` - текст (будет один для всех языков).

Опции форматера
---------------

Все оставшиеся опции обрабатываются указанным |formatters_link|.
Вот, к примеру некоторые из них:

+----------------------+--------------------------------------------------------------------------------------+
| название опции       | описание опции                                                                       |
+======================+======================================================================================+
| .. config-property:: | Название класса накладываемого форматера. Вот самые ходовые классы:                  |
|    :name: formatter  |                                                                                      |
|    :type: string     | - :ref:`fmt_class_kFormatter` - для обработки чисел, денежных сумм, почтовых адресов |
|    :ref_prefix: tfd_ | - :ref:`fmt_class_kOptionsFormatter` - для работы с элементами ограниченного выбора  |
|                      |   (dropdown, radio buttons и т.п.)                                                   |
|                      | - :ref:`fmt_class_kDateFormatter` - для обработки дат                                |
|                      | - :ref:`fmt_class_kUploadFormatter` - для загрузки файлов на сервер                  |
|                      |                                                                                      |
|                      | Подробнее о том, какие есть форматеры и как их использовать можно прочесть в         |
|                      | :doc:`этой статье </components/unit_configs/formatters>`.                            |
+----------------------+--------------------------------------------------------------------------------------+

Автоматическое построение структуры
-----------------------------------

.. versionadded:: 4.1.0

В K4 есть механизм, который автоматически выстраивает массив для опции :ref:`uc_Fields`. Чтобы воспользоваться
им следуйте приведённым шагам:

- пойти в секцию "Configuration -> System Tools" (в Platform) или "Tools -> System Tools" (в In-Portal);
- в поле "Table Structure" вписать **имя таблицы** (можно без :ref:`const_TABLE_PREFIX`) или
  :ref:`префикс <uc_Prefix>` от :doc:`unit config </components/unit_configs/config_files>`;
- нажать на кнопку "Go";
- откроется новое окно со структурой введённой таблицы:

.. figure:: /images/Table_Structure.gif
   :alt: Автоматически построенная структура таблицы

   Автоматически построенная структура таблицы

.. warning::

   При добавлении новых полей в таблицу нужно повторить все выше описанные шаги, но из результата
   скопировать описание только нужных полей, а не всех как обычно. Не надо писать всё руками.

При построении структуры полям автоматически прописываются (если удаётся определить) следующие опции:

- ``type`` - php тип значения, которое будет храниться в поле;
- ``not_null`` - NULL или NOT NULL пометка;
- ``default`` - значение по умолчанию;
- ``formatter`` - класс форматера, пока только для дробный полей (float, double, decimal);
- ``max_len`` - ограничение по длине значения в поле, только для строковых полей (varchar).

.. _Data Source: http://guide.in-portal.org/rus/index.php/K4:%D0%9E%D0%BF%D0%B8%D1%81%D0%B0%D0%BD%D0%B8%D0%B5_%D0%BF%D0%BE%D0%BB%D0%B5%D0%B9_%D1%82%D0%B0%D0%B1%D0%BB%D0%B8%D1%86%D1%8B
.. _Eng Data Source: http://guide.in-portal.org/eng/index.php/K4:Defining_Database%2C_Virtual_and_Calculated_Fields

.. |formatters_link| replace:: :doc:`форматером </components/unit_configs/formatters>`
